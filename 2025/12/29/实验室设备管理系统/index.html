<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>实验室设备管理系统 | Boomfreezing</title><meta name="author" content="Boom_freezing"><meta name="copyright" content="Boom_freezing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="高校实验室设备管理系统设计实现全流程报告">
<meta property="og:type" content="article">
<meta property="og:title" content="实验室设备管理系统">
<meta property="og:url" content="http://boomfreezing.github.io/2025/12/29/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="Boomfreezing">
<meta property="og:description" content="高校实验室设备管理系统设计实现全流程报告">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://boomfreezing.github.io/images/%E6%95%B0%E6%8D%AE%E5%BA%93/cover.jpg">
<meta property="article:published_time" content="2025-12-29T03:05:42.000Z">
<meta property="article:modified_time" content="2025-12-29T03:40:29.394Z">
<meta property="article:author" content="Boom_freezing">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="TaurusDB">
<meta property="article:tag" content="python">
<meta property="article:tag" content="SQL">
<meta property="article:tag" content="Vue">
<meta property="article:tag" content="Flask">
<meta property="article:tag" content="E-R图">
<meta property="article:tag" content="触发器">
<meta property="article:tag" content="存储过程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://boomfreezing.github.io/images/%E6%95%B0%E6%8D%AE%E5%BA%93/cover.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "实验室设备管理系统",
  "url": "http://boomfreezing.github.io/2025/12/29/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/",
  "image": "http://boomfreezing.github.io/images/%E6%95%B0%E6%8D%AE%E5%BA%93/cover.jpg",
  "datePublished": "2025-12-29T03:05:42.000Z",
  "dateModified": "2025-12-29T03:40:29.394Z",
  "author": [
    {
      "@type": "Person",
      "name": "Boom_freezing",
      "url": "http://boomfreezing.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/head.jpg"><link rel="canonical" href="http://boomfreezing.github.io/2025/12/29/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":10,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '实验室设备管理系统',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script type="module">(async function(){
  try{
    const mod = await import('/dist/live2d-widget-master/dist/waifu-tips.js');
    const init = mod.initWidget || mod.default || window.initWidget;
    if(typeof init === 'function'){
      const cfg = {
        waifuPath: '/dist/live2d-widget-master/dist/waifu-tips.json',
        modelId: 0,
        modelTexturesId: 0,
        cubism2Path: '/dist/live2d-widget-master/dist/live2d.min.js',
        cubism5Path: 'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',
        tools: ['hitokoto','asteroids','switch-model','switch-texture','photo','info','quit'],
        logLevel: 'info',
        drag: false
      };
      try{ localStorage.removeItem('modelId'); localStorage.removeItem('modelTexturesId'); }catch(e){}
      init(cfg);
    }
  }catch(e){console.warn('[waifu] head module init failed', e);}    )();
</script><!-- Polling fallback: wait until initWidget is available then call it (non-module, early)--><script>(function(){
  try{
      var cfg = {
        waifuPath: '/dist/live2d-widget-master/dist/waifu-tips.json',
        modelId: 0,
        modelTexturesId: 0,
        cubism2Path: '/dist/live2d-widget-master/dist/live2d.min.js',
        cubism5Path: 'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',
        tools: ['hitokoto','asteroids','switch-model','switch-texture','photo','info','quit'],
        logLevel: 'info',
        drag: false
      };
    var tries = 0, maxTries = 100;
    function waitInit(){
      tries++;
      if(typeof initWidget === 'function'){
        try{ localStorage.removeItem('modelId'); localStorage.removeItem('modelTexturesId'); }catch(e){}
        try{ initWidget(cfg); console.info('[waifu] waitInit called initWidget'); }catch(e){ console.error('[waifu] waitInit initWidget error', e); }
        return;
      }
      if(tries < maxTries) setTimeout(waitInit, 80);
      else console.warn('[waifu] waitInit: initWidget not available after retries');
    }
    setTimeout(waitInit, 40);
  }catch(e){ console.warn('[waifu] waitInit setup failed', e); }
})();</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/header.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">9</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives"><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories"><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags"><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link"><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about"><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/数据库/cover.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Boomfreezing</span></a><a class="nav-page-title" href="/"><span class="site-name">实验室设备管理系统</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives"><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories"><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags"><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link"><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about"><span> 关于我</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">实验室设备管理系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-29T03:05:42.000Z" title="发表于 2025-12-29 11:05:42">2025-12-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-29T03:40:29.394Z" title="更新于 2025-12-29 11:40:29">2025-12-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/">数据库系统原理</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">19.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>76分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1>实验室设备管理系统</h1>
<div style="text-align: right;">作者：King_CB & Boomfreezing</div>
<hr>
<h2 id="零、说明">零、说明</h2>
<h3 id="0-1-贡献说明">0.1 贡献说明</h3>
<table>
<thead>
<tr>
<th style="text-align:center">姓名</th>
<th style="text-align:center">子任务1：查询-预约-审批</th>
<th style="text-align:center">子任务2：维修-采购-审批</th>
<th style="text-align:center">工作量占比</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">King_CB</td>
<td style="text-align:center">想法讨论<br>需求分析<br>查询-预约-审批前后端代码实现</td>
<td style="text-align:center">想法讨论<br>前后端测试</td>
<td style="text-align:center">50%</td>
</tr>
<tr>
<td style="text-align:center">Boomfreezing</td>
<td style="text-align:center">想法讨论<br>前后端测试</td>
<td style="text-align:center">想法讨论<br>需求分析<br>维修-采购-审批前后端代码实现</td>
<td style="text-align:center">50%</td>
</tr>
</tbody>
</table>
<h3 id="0-2-代码说明">0.2 代码说明</h3>
<p>本项目代码已放入<a target="_blank" rel="noopener" href="https://github.com/KingCB0501/BUAA-2025-Database">GitHub</a>仓库，包括<strong>源代码</strong>、<strong>设计报告</strong>、<strong>实现报告</strong>、<strong>本地部署方法</strong>、<strong>系统演示视频</strong></p>
<h3 id="0-3-共创说明">0.3 共创说明</h3>
<p>共创者King_CB<a target="_blank" rel="noopener" href="https://kingcb0501.github.io/">博客链接</a></p>
<hr>
<h2 id="一、需求分析">一、需求分析</h2>
<h3 id="1-需求描述">1. 需求描述</h3>
<p>本项目实现了高校实验室设备管理系统，支持普通用户、实验室管理员、维修人员三类用户的设备查询、统计分析、预约、使用、报修、维修任务分配与零件采购审批等功能。</p>
<ul>
<li><strong>普通用户</strong> 可以查询设备信息，预约设备、使用设备、设备报修；</li>
<li><strong>管理员用户</strong> 负责审批设备预约请求、分发维修任务，审批维修用户的采购申请；可以进行设备的增删改查，对于用户信息与零件进行管理维护。</li>
<li><strong>维修人员</strong> 处理管理员用户分发给自己的修理任务，也可申请零件采购以完成相应维修任务。</li>
</ul>
<h3 id="2-系统功能设计">2. 系统功能设计</h3>
<h4 id="2-1-普通用户功能">2.1 普通用户功能</h4>
<ul>
<li><strong>设备信息查询</strong>：用户可以查询到所有设备信息和与自己相关的设备预约、使用与维修记录。</li>
<li><strong>设备预约</strong>：用户可以预约某设备，预约时指定预计使用开始时间与结束时间，用户需提交使用目的。如果期望使用时段内该设备已经被预约，则系统提示预约失败。维修中设备不可预约。用户可以随时查看预约的进程。</li>
<li><strong>设备使用</strong>：预约成功后在预约记录的期望使用时间内可以使用该设备。如果预约使用时间结束之后用户未停止使用，则系统强制停止。</li>
<li><strong>设备报修</strong>：用户可以提交设备报修请求（描述，故障图片，优先级）；可以查看与自己相关的设备报修记录的处理进程。</li>
</ul>
<h4 id="2-2-管理员用户功能">2.2 管理员用户功能</h4>
<ul>
<li><strong>设备管理</strong>：管理员可以增删设备或者修改设备信息。</li>
<li><strong>预约审批</strong>：管理员用户审批用户的预约请求，可选通过后拒绝。如果拒绝，需要填写拒绝说明。</li>
<li><strong>维修任务分配</strong>：管理员可以根据各维修人员的任务总数与擅长领域等分发维修任务，可以修改任务优先级。</li>
<li><strong>零件管理</strong>：管理员可以增删改查零件与生产厂商信息。</li>
<li><strong>采购审批</strong>：管理员通过或拒绝维修人员发起的采购申请，记录审批意见。</li>
<li><strong>用户管理</strong>：管理员可以查看各用户信息，并重置密码。</li>
<li><strong>统计分析</strong>：管理员端可以查看设备使用率，预约通过率等信息。</li>
</ul>
<h4 id="2-3-维修人员用户功能">2.3 维修人员用户功能</h4>
<ul>
<li><strong>维修任务处理</strong>：维修人员查看分配给自己的任务，并进行维修，更新任务进度。</li>
<li><strong>零件采购</strong>：当维修任务中需要某零件时，维修人员可以发起采购审批，由管理员审批。</li>
</ul>
<h3 id="3-数据流图">3. 数据流图</h3>
<h4 id="3-1-顶层数据流图">3.1 顶层数据流图</h4>
<p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%A1%B6%E5%B1%82%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE.png" alt=""></p>
<h4 id="3-2-业务数据流图">3.2 业务数据流图</h4>
<p><strong>3.2.1 设备预约-审批-使用数据流图</strong></p>
<p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BE%E5%A4%87%E9%A2%84%E7%BA%A6-%E5%AE%A1%E6%89%B9-%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE.png" alt=""></p>
<p><strong>3.2.2 故障报备-任务分发-设备维修 数据流图</strong></p>
<p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%85%E9%9A%9C%E6%8A%A5%E5%A4%87-%E4%BB%BB%E5%8A%A1%E5%88%86%E5%8F%91-%E8%AE%BE%E5%A4%87%E7%BB%B4%E4%BF%AE%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE.png" alt=""></p>
<p><strong>3.2.3 零件采购-审批数据流图</strong></p>
<p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9B%B6%E4%BB%B6%E9%87%87%E8%B4%AD-%E5%AE%A1%E6%89%B9%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE.png" alt=""></p>
<h3 id="4-数据元素表">4. 数据元素表</h3>
<h4 id="1-普通用户">(1) 普通用户</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">ID</th>
<th style="text-align:left">用户名</th>
<th style="text-align:left">密码</th>
<th style="text-align:left">学院</th>
<th style="text-align:left">电话</th>
<th style="text-align:left">邮箱</th>
<th style="text-align:left">头像</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">50</td>
<td style="text-align:left">255</td>
<td style="text-align:left">50</td>
<td style="text-align:left">20</td>
<td style="text-align:left">30</td>
<td style="text-align:left">255</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">合法联系电话</td>
<td style="text-align:left">合法邮箱地址</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<h4 id="2-管理员">(2) 管理员</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">ID</th>
<th style="text-align:left">用户名</th>
<th style="text-align:left">密码</th>
<th style="text-align:left">电话</th>
<th style="text-align:left">邮箱</th>
<th style="text-align:left">头像</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">50</td>
<td style="text-align:left">255</td>
<td style="text-align:left">20</td>
<td style="text-align:left">30</td>
<td style="text-align:left">255</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">合法联系电话</td>
<td style="text-align:left">合法邮箱地址</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<h4 id="3-维修人员">(3) 维修人员</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">ID</th>
<th style="text-align:left">用户名</th>
<th style="text-align:left">密码</th>
<th style="text-align:left">电话</th>
<th style="text-align:left">邮箱</th>
<th style="text-align:left">头像</th>
<th style="text-align:left">维修专长</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">50</td>
<td style="text-align:left">255</td>
<td style="text-align:left">20</td>
<td style="text-align:left">30</td>
<td style="text-align:left">255</td>
<td style="text-align:left">50</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">合法联系电话</td>
<td style="text-align:left">合法邮箱地址</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<h4 id="4-实验室">(4) 实验室</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">ID</th>
<th style="text-align:left">名称</th>
<th style="text-align:left">位置</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">text</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">20</td>
<td style="text-align:left">200</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<h4 id="5-设备">(5) 设备</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">ID</th>
<th style="text-align:left">名称</th>
<th style="text-align:left">所属实验室ID</th>
<th style="text-align:left">设备分类</th>
<th style="text-align:left">状态</th>
<th style="text-align:left">设备型号</th>
<th style="text-align:left">购置日期</th>
<th style="text-align:left">购置价格</th>
<th style="text-align:left">设备介绍(使用方法)</th>
<th style="text-align:left">设备图片</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">int</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">date</td>
<td style="text-align:left">decimal(10,2)</td>
<td style="text-align:left">text</td>
<td style="text-align:left">varchar</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">200</td>
<td style="text-align:left">32</td>
<td style="text-align:left">100</td>
<td style="text-align:left">/</td>
<td style="text-align:left">100</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">255</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">/</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<p><em>设备状态有：可用/使用中/维修中/已报废等状态。</em></p>
<h4 id="6-预约记录">(6) 预约记录</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">预约编号</th>
<th style="text-align:left">用户ID</th>
<th style="text-align:left">设备ID</th>
<th style="text-align:left">提交时间</th>
<th style="text-align:left">开始时间</th>
<th style="text-align:left">结束时间</th>
<th style="text-align:left">审批状态</th>
<th style="text-align:left">审批管理员ID</th>
<th style="text-align:left">使用说明</th>
<th style="text-align:left">审批意见</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">date</td>
<td style="text-align:left">date</td>
<td style="text-align:left">date</td>
<td style="text-align:left">Enum</td>
<td style="text-align:left">int</td>
<td style="text-align:left">text</td>
<td style="text-align:left">text</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">32</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<p><em>审批状态有：待审批/驳回/通过三种状态。</em></p>
<h4 id="7-使用记录">(7) 使用记录</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">使用编号</th>
<th style="text-align:left">关联预约 ID</th>
<th style="text-align:left">开始时间</th>
<th style="text-align:left">结束时间</th>
<th style="text-align:left">状态</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">date</td>
<td style="text-align:left">date</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">text</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<p><em>使用记录的状态有：使用中/已完成/已取消三种状态。</em></p>
<h4 id="8-维修记录">(8) 维修记录</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">维修编号</th>
<th style="text-align:left">设备ID</th>
<th style="text-align:left">报备用户ID</th>
<th style="text-align:left">分派管理员ID</th>
<th style="text-align:left">维修人员ID</th>
<th style="text-align:left">问题标题</th>
<th style="text-align:left">问题描述</th>
<th style="text-align:left">优先级</th>
<th style="text-align:left">状态</th>
<th style="text-align:left">故障图片</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">text</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">varchar</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">100</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">255</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<p><em>优先级有：低/中/高/紧急四种状态。</em><br>
<em>状态有：待处理/待分配/维修中/已完成/已取消五种状态。</em></p>
<h4 id="9-报修进度变化表">(9) 报修进度变化表</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">进度ID</th>
<th style="text-align:left">报修记录ID</th>
<th style="text-align:left">操作人身份</th>
<th style="text-align:left">操作人ID</th>
<th style="text-align:left">变化后状态</th>
<th style="text-align:left">备注</th>
<th style="text-align:left">创建时间</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">int</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">text</td>
<td style="text-align:left">date</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">/</td>
<td style="text-align:left">32</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">否</td>
</tr>
</tbody>
</table>
<p><em>身份有：普通用户/管理员/维修人员三类。</em><br>
<em>变化后状态是指维修记录经过此次变更后的状态。</em></p>
<h4 id="10-零件">(10) 零件</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">零件ID</th>
<th style="text-align:left">零件名称</th>
<th style="text-align:left">零件类型</th>
<th style="text-align:left">计量单位</th>
<th style="text-align:left">零件描述</th>
<th style="text-align:left">零件图片</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">text</td>
<td style="text-align:left">varchar</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">100</td>
<td style="text-align:left">/</td>
<td style="text-align:left">10</td>
<td style="text-align:left">/</td>
<td style="text-align:left">255</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<h4 id="11-生产厂商表">(11) 生产厂商表</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">厂商ID</th>
<th style="text-align:left">厂商名称</th>
<th style="text-align:left">联系人</th>
<th style="text-align:left">联系电话</th>
<th style="text-align:left">地址</th>
<th style="text-align:left">网站</th>
<th style="text-align:left">介绍</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">varchar</td>
<td style="text-align:left">text</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">100</td>
<td style="text-align:left">20</td>
<td style="text-align:left">30</td>
<td style="text-align:left">255</td>
<td style="text-align:left">255</td>
<td style="text-align:left">text</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<p><em>状态有：工作/停产两种状态。</em></p>
<h4 id="12-零件-生产商关联表">(12) 零件-生产商关联表</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">ID</th>
<th style="text-align:left">生产商编号</th>
<th style="text-align:left">零件ID</th>
<th style="text-align:left">单价</th>
<th style="text-align:left">交货周期</th>
<th style="text-align:left">是否为首选供应商</th>
<th style="text-align:left">质量评分</th>
<th style="text-align:left">备注说明</th>
<th style="text-align:left">状态</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">decimal(10,2)</td>
<td style="text-align:left">int</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">decimal(3,2)</td>
<td style="text-align:left">text</td>
<td style="text-align:left">enum</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">/</td>
<td style="text-align:left">32</td>
<td style="text-align:left">1</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">否</td>
</tr>
</tbody>
</table>
<h4 id="13-采购记录">(13) 采购记录</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">采购编号</th>
<th style="text-align:left">零件生产商关联ID</th>
<th style="text-align:left">报修记录ID</th>
<th style="text-align:left">紧急程度</th>
<th style="text-align:left">采购说明</th>
<th style="text-align:left">审批管理员ID</th>
<th style="text-align:left">审批时间</th>
<th style="text-align:left">审批意见</th>
<th style="text-align:left">状态</th>
<th style="text-align:left">期望到货时间</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">text</td>
<td style="text-align:left">int</td>
<td style="text-align:left">date</td>
<td style="text-align:left">text</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">date</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">32</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<p><em>紧急程度分为：低/中/高三级。</em><br>
<em>状态包含：待审批/已批准/已拒绝/已取消四种。</em></p>
<h4 id="14-采购工单进度表">(14) 采购工单进度表</h4>
<table>
<thead>
<tr>
<th style="text-align:left">数据项</th>
<th style="text-align:left">ID</th>
<th style="text-align:left">采购工单ID</th>
<th style="text-align:left">操作人身份</th>
<th style="text-align:left">操作人ID</th>
<th style="text-align:left">变化后状态</th>
<th style="text-align:left">备注</th>
<th style="text-align:left">创建时间</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">数据类型</td>
<td style="text-align:left">int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">int</td>
<td style="text-align:left">enum</td>
<td style="text-align:left">text</td>
<td style="text-align:left">date</td>
</tr>
<tr>
<td style="text-align:left">数据宽度</td>
<td style="text-align:left">32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">/</td>
<td style="text-align:left">32</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">值约束</td>
<td style="text-align:left">主键</td>
<td style="text-align:left">外码</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
</tr>
<tr>
<td style="text-align:left">允许空值</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">否</td>
</tr>
</tbody>
</table>
<p><em>操作人身份包括：维修人员/审批员两类。</em><br>
<em>变化后状态是指维修记录经过此次变更后的状态。</em></p>
<hr>
<h2 id="二、数据库概念模式设计">二、数据库概念模式设计</h2>
<h3 id="1-系统初步E-R图">1. 系统初步E-R图</h3>
<p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/E-R%E5%9B%BE.png" alt=""></p>
<h3 id="2-系统基本-E-R-图">2. 系统基本 E-R 图</h3>
<p>初步 ER 图中不存在冗余或不合理的实体与联系，因此基本 ER 图与其相同。</p>
<p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/E-R%E5%9B%BE.png" alt=""></p>
<p>现对其作一定说明：</p>
<ul>
<li><strong>黄色</strong>代表物理实体；</li>
<li><strong>蓝色</strong>代表记录实体，其实际上是由物理实体之间的联系而产生的，但是鉴于其在业务交互中的复杂性，我们将其升级为实体处理。例如普通用户报备设备故障后生成报修记录，该记录随维修流程推进不断更新状态，涉及多个操作人身份的介入与审批流转；</li>
<li><strong>红色与橙色</strong>代表物理实体与记录实体之间的联系和联系的属性；</li>
<li><strong>紫色</strong>代表物理实体之间的联系；</li>
</ul>
<hr>
<h2 id="三、数据库逻辑模式设计与优化">三、数据库逻辑模式设计与优化</h2>
<h3 id="1-数据库关系模式定义">1. 数据库关系模式定义</h3>
<h4 id="1-1-实体的关系模式">1.1 实体的关系模式</h4>
<ol>
<li>普通用户(id，用户名，密码，学院，电话，邮箱，头像)</li>
<li>管理员用户(id，用户名，密码，电话，邮箱，头像)</li>
<li>维修人员(id，用户名，密码，电话，邮箱，头像，维修专长)</li>
<li>设备(设备 id，设备名称，类型，状态，设备型号，购置日期，购置价格，使用介绍，图片，设备所属实验室 id，设备位置)</li>
<li>实验室(实验室 id，名称，位置，描述)</li>
<li>生产商(生产商 id，名称，联系人，联系方式，地址，网站，介绍)</li>
<li>零件(零件 id，名称，类型，计量单位，零件描述)</li>
<li>预约记录(预约记录编号，设备 id，提交时间，开始时间，结束时间，使用说明，使用时间总和)</li>
<li>维修记录(维修记录 id，设备 id，问题描述，优先级，状态，故障图片)</li>
<li>采购记录(采购记录 id，零件生产商关联 id，报修记录 id，紧急程度，采购说明，期望到货时间)</li>
</ol>
<h4 id="1-2-联系的关系模式">1.2 联系的关系模式</h4>
<ol>
<li>用户预约(用户 id，预约记录编号)</li>
<li>管理员预约审批(管理员用户 id，预约记录 id，状态，审批时间，审批意见)</li>
<li>报修(普通用户 id，维修记录 id，报修时间)</li>
<li>分发(管理员用户 id，维修记录 id，分发时间)</li>
<li>维修(维修人员 id，维修记录 id)</li>
<li>采购审批(审批管理员 id，采购记录 id，审批意见，状态)</li>
<li>包含(实验室 id，设备 id)</li>
<li>增加设备(用户 id，设备 id，增加/删除，修改时间)</li>
<li>生产商供应零件(生产商 id，零件 id，单价，交货周期，是否为首选供应商，质量评分，备注说明)</li>
<li>报修进度变化表(id，维修记录 id，状态变化，更新时间，操作人角色，操作人 id，备注)</li>
<li>采购进度变化表(id，采购记录 id，操作人角色，操作人 id，变化后状态，创建时间，备注)</li>
</ol>
<h3 id="2-关系模式范式等级的判定与规范化">2. 关系模式范式等级的判定与规范化</h3>
<p>设备表与预约记录表不满足 3NF 要求，对其进行规范化。</p>
<h4 id="2-1-实体的关系模式（规范化后）">2.1 实体的关系模式（规范化后）</h4>
<ol>
<li>普通用户(id，用户名，密码，学院，电话，邮箱，头像)</li>
<li>管理员用户(id，用户名，密码，电话，邮箱，头像)</li>
<li>维修人员(id，用户名，密码，电话，邮箱，头像，维修专长)</li>
<li>设备(设备 id，设备名称，类型，状态，设备型号，购置日期，购置价格，使用介绍，图片)</li>
<li>实验室(实验室 id，名称，位置，描述)</li>
<li>生产商(生产商 id，名称，联系人，联系方式，地址，网站，介绍)</li>
<li>零件(零件 id，名称，类型，计量单位，零件描述)</li>
<li>预约记录(预约记录编号，设备 id，提交时间，开始时间，结束时间，使用说明)</li>
<li>维修记录(维修记录 id，设备 id，问题描述，优先级，状态，故障图片)</li>
<li>采购记录(采购记录 id，零件生产商关联 id，报修记录 id，紧急程度，采购说明，期望到货时间)</li>
</ol>
<h4 id="2-2-联系的关系模式（规范化后）">2.2 联系的关系模式（规范化后）</h4>
<ol>
<li>用户预约(用户 id，预约记录编号)</li>
<li>管理员预约审批(管理员用户 id，预约记录 id，状态，审批时间，审批意见)</li>
<li>报修(普通用户 id，维修记录 id，报修时间)</li>
<li>分发(管理员用户 id，维修记录 id，分发时间)</li>
<li>维修(维修人员 id，维修记录 id)</li>
<li>采购审批(审批管理员 id，采购记录 id，审批意见，状态)</li>
<li>包含(实验室 id，设备 id)</li>
<li>增删设备(用户 id，设备 id，增加/删除，修改时间)</li>
<li>生产商供应零件(生产商 id，零件 id，单价，交货周期，是否为首选供应商，质量评分，备注说明)</li>
<li>报修进度变化表(id，维修记录 id，状态变化，更新时间，操作人角色，操作人 id，备注)</li>
<li>采购进度变化表(id，采购记录 id，操作人角色，操作人 id，变化后状态，创建时间，备注)</li>
</ol>
<h3 id="3-数据库关系模式优化">3. 数据库关系模式优化</h3>
<p>将用户预约与管理员预约审批两个联系的表的内容合并到预约记录表中，减少存储表的数量，减少 join 连接所需时间。对报修、分发、维修三个联系的表进行合并，统一集成至维修记录表中，通过添加对应字段标识不同操作环节。将采购审批内容合并到采购记录表中。</p>
<h4 id="3-1-实体的关系模式（优化后）">3.1 实体的关系模式（优化后）</h4>
<ol>
<li>普通用户(id，用户名，密码，学院，电话，邮箱，头像)</li>
<li>管理员用户(id，用户名，密码，电话，邮箱，头像)</li>
<li>维修人员(id，用户名，密码，电话，邮箱，头像，维修专长)</li>
<li>设备(设备 id，设备名称，类型，状态，设备所属实验室 ID，设备型号，购置日期，购置价格，使用介绍，图片)</li>
<li>实验室(实验室 id，名称，位置，描述)</li>
<li>生产商(生产商 id，名称，联系人，联系方式，地址，网站，介绍)</li>
<li>零件(零件 id，名称，类型，计量单位，零件描述)</li>
<li><strong>预约记录</strong>(预约记录编号，用户 id，设备 id，提交时间，开始时间，结束时间，审批状态，审批管理员 id，审批时间，使用说明，审批意见)</li>
<li><strong>维修记录</strong>(维修记录 id，报修用户 id，设备 id，分发管理员 id，维修人员 id，问题描述，优先级，状态，故障图片)</li>
<li><strong>采购记录</strong>(采购记录 id，零件生产商关联 id，报修记录 id，紧急程度，采购说明，审批管理员 id，审批意见，状态，期望到货时间)</li>
</ol>
<h4 id="3-2-联系的关系模式（优化后）">3.2 联系的关系模式（优化后）</h4>
<ol>
<li>增删设备(用户 id，设备 id，增加/删除，修改时间)</li>
<li>生产商供应零件(生产商 id，零件 id，单价，交货周期，是否为首选供应商，质量评分，备注说明)</li>
<li>报修进度变化表(id，维修记录 id，状态变化，更新时间，操作人角色，操作人 id，备注)</li>
<li>采购进度变化表(id，采购记录 id，操作人角色，操作人 id，变化后状态，创建时间，备注)</li>
</ol>
<hr>
<h2 id="四、数据库物理设计">四、数据库物理设计</h2>
<ol>
<li><strong>关系模式简化</strong>：一些联系形成的表的字段内容较少，可直接并入实体表中以减少表的数目及关联开销，如报修、分发等联系表。</li>
<li><strong>数据库外模式(视图)</strong>：为不同的后端接口建立不同视图，降低查询难度，同时保证了数据的安全性。例如 <code>v_all_user</code> 视图整合三类用户，为用户统一认证提供接口。</li>
<li><strong>建立索引</strong>：
<ul>
<li>对所有的表，根据主码与外码建立了索引。例如预约记录中的用户 id、设备 id 字段。</li>
<li>在采购进度变化表建立了时间索引，用于按时间倒序查看采购订单的最新进度记录。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="五、系统结构设计">五、系统结构设计</h2>
<h3 id="5-1-体系结构">5.1 体系结构</h3>
<p>本项目采用B/S三层架构，基于前后端分离的设计理念，实现了实验室设备管理系统的数据层、业务逻辑层和表现层的完全结构。</p>
<p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt=""></p>
<h4 id="5-1-1-前端架构及技术栈">5.1.1 前端架构及技术栈</h4>
<p>前端采用 Vue 3 作为核心框架，基于组合式 API 构建组件化、响应式的用户界面，提升代码的可维护性与复用性。项目使用 Vite 作为构建工具，具备启动快、热更新高效的特点；配合 Vue Router 实现单页应用的路由管理，Pinia 负责全局状态（如登录状态、用户信息、Token 等）的集中管理；UI 层采用 Element Plus 组件库，快速构建一致、美观的界面；Axios 统一封装 HTTP 请求，实现与后端接口的高效通信。前端框架及技术栈如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">└─frontend</span><br><span class="line">    └─src</span><br><span class="line">        ├─api # 存储进行前后端交互的API方法的JavaScript文件</span><br><span class="line">        ├─layouts # 存放页面布局组件</span><br><span class="line">        ├─router # 存放Vue项目的路由配置文件</span><br><span class="line">        ├─stores # 存放保存全局状态的Pinia插件的文件，管理用户登录状态、个人信息、Token等全局数据</span><br><span class="line">        ├─utils # 存放工具函数和公共方法</span><br><span class="line">        └─views # 存放基本页面的Vue文件</span><br><span class="line">            └─admin</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">技术</th>
<th style="text-align:center">版本</th>
<th style="text-align:center">职责</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Vue3</td>
<td style="text-align:center">Vue 3.4.0</td>
<td style="text-align:center">核心框架</td>
</tr>
<tr>
<td style="text-align:center">Vite</td>
<td style="text-align:center">Vite 5.0.0</td>
<td style="text-align:center">构建工具</td>
</tr>
<tr>
<td style="text-align:center">Element Plus</td>
<td style="text-align:center">Element Plus 2.5.0</td>
<td style="text-align:center">UI组件库</td>
</tr>
<tr>
<td style="text-align:center">Vue Router</td>
<td style="text-align:center">Vue Router 4.2.5</td>
<td style="text-align:center">路由管理</td>
</tr>
<tr>
<td style="text-align:center">Pinia</td>
<td style="text-align:center">Pinia 2.1.7</td>
<td style="text-align:center">状态管理</td>
</tr>
<tr>
<td style="text-align:center">Axios</td>
<td style="text-align:center">Axios 5.0.0</td>
<td style="text-align:center">HTTP请求</td>
</tr>
</tbody>
</table>
<h4 id="5-1-2-后端架构及技术栈">5.1.2 后端架构及技术栈</h4>
<p>后端基于 Flask 框架构建，采用轻量化、模块化的设计思想，便于快速开发与灵活扩展。系统以 Python 3.9+ 为开发语言，通过路由层（routes）暴露 RESTful API，数据访问层（database/DAO）负责原生 SQL 与数据库交互，工具层（utils）封装通用功能。认证与安全方面使用 Flask-JWT-Extended 实现基于 JWT 的身份验证，bcrypt 进行密码加密，Flask-CORS 支持跨域访问；底层数据库选用 TaurusDB MySQL，保证数据的可靠性与一致性。后端框架及技术栈如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">└─backend</span><br><span class="line">   ├─app # 后端核心代码</span><br><span class="line">   │  ├─database # 数据访问层（DAO层）</span><br><span class="line">   │  ├─routes # 路由层（API端点）</span><br><span class="line">   │  └─utils # 工具函数层</span><br><span class="line">   ├─docs # 项目相关文档说明</span><br><span class="line">   ├─migrations # 数据库迁移</span><br><span class="line">   └─tests # 测试代码目录</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">技术</th>
<th style="text-align:center">版本</th>
<th style="text-align:center">职责</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Python</td>
<td style="text-align:center">3.9+</td>
<td style="text-align:center">编程语言</td>
</tr>
<tr>
<td style="text-align:center">Flask</td>
<td style="text-align:center">2.3.0</td>
<td style="text-align:center">web框架</td>
</tr>
<tr>
<td style="text-align:center">Flask-JWT-Extended</td>
<td style="text-align:center">4.5.0</td>
<td style="text-align:center">JWT认证</td>
</tr>
<tr>
<td style="text-align:center">Flask-CORS</td>
<td style="text-align:center">4.0.0</td>
<td style="text-align:center">跨域支持</td>
</tr>
<tr>
<td style="text-align:center">PyMySQL</td>
<td style="text-align:center">1.1.0</td>
<td style="text-align:center">数据库驱动</td>
</tr>
<tr>
<td style="text-align:center">bcrypt</td>
<td style="text-align:center">4.0.1</td>
<td style="text-align:center">密码加密</td>
</tr>
<tr>
<td style="text-align:center">cryptography</td>
<td style="text-align:center">41.0.0</td>
<td style="text-align:center">SSL加密工具</td>
</tr>
<tr>
<td style="text-align:center">python-dotenv</td>
<td style="text-align:center">1.0.0</td>
<td style="text-align:center">环境变量</td>
</tr>
<tr>
<td style="text-align:center">Werkeug</td>
<td style="text-align:center">2.3.0</td>
<td style="text-align:center">WSGI工具库</td>
</tr>
<tr>
<td style="text-align:center">TaurusDB MySQL</td>
<td style="text-align:center">8.0.22-30</td>
<td style="text-align:center">关系数据库</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="六、数据库基本表的定义">六、数据库基本表的定义</h2>
<h3 id="6-1-管理员表">6.1 管理员表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>用户名</th>
<th>密码</th>
<th>邮箱</th>
<th>电话</th>
<th>头像</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>varchar(50)</td>
<td>varchar(255)</td>
<td>varchar(30)</td>
<td>varchar(20)</td>
<td>varchar(255)</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空</td>
<td>非空</td>
<td>/</td>
<td>/</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>管理员ID</td>
<td>登录账号</td>
<td>加密密码</td>
<td>邮箱地址</td>
<td>联系电话</td>
<td>用户头像URL</td>
</tr>
</tbody>
</table>
<h3 id="6-2-普通用户表">6.2 普通用户表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>用户名</th>
<th>密码</th>
<th>邮箱</th>
<th>电话</th>
<th>头像</th>
<th>学院</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>varchar(50)</td>
<td>varchar(255)</td>
<td>varchar(30)</td>
<td>varchar(20)</td>
<td>varchar(255)</td>
<td>varchar(50)</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空</td>
<td>非空</td>
<td>/</td>
<td>/</td>
<td>/</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>普通用户ID</td>
<td>登录账号</td>
<td>加密密码</td>
<td>邮箱地址</td>
<td>联系电话</td>
<td>用户头像URL</td>
<td>所属学院</td>
</tr>
</tbody>
</table>
<h3 id="6-3-维修员表">6.3 维修员表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>用户名</th>
<th>密码</th>
<th>邮箱</th>
<th>电话</th>
<th>头像</th>
<th>专业</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>varchar(50)</td>
<td>varchar(255)</td>
<td>varchar(30)</td>
<td>varchar(20)</td>
<td>varchar(255)</td>
<td>varchar(50)</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空</td>
<td>非空</td>
<td>/</td>
<td>/</td>
<td>/</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>维修人员ID</td>
<td>登录账号</td>
<td>加密密码</td>
<td>邮箱地址</td>
<td>联系电话</td>
<td>用户头像URL</td>
<td>擅长领域</td>
</tr>
</tbody>
</table>
<h3 id="6-4-实验室表">6.4 实验室表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>实验室名</th>
<th>位置</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>varchar(20)</td>
<td>varchar(200)</td>
<td>text</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空</td>
<td>/</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>实验室ID</td>
<td>实验室名称</td>
<td>实验室位置</td>
<td>相关描述</td>
</tr>
</tbody>
</table>
<h3 id="6-5-设备表">6.5 设备表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>设备名称</th>
<th>所属实验室ID</th>
<th>设备分类</th>
<th>型号</th>
<th>购置日期</th>
<th>购置价格</th>
<th>状态</th>
<th>描述</th>
<th>图片</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>varchar(200)</td>
<td>int(32)</td>
<td>varchar(100)</td>
<td>varchar(100)</td>
<td>date</td>
<td>decimal(10,2)</td>
<td>enum</td>
<td>text</td>
<td>varchar(255)</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空</td>
<td>外键</td>
<td>/</td>
<td>/</td>
<td>/</td>
<td>/</td>
<td>默认“可用”</td>
<td>/</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>设备ID</td>
<td>设备名称</td>
<td>所属实验室</td>
<td>设备分类</td>
<td>设备型号</td>
<td>购置日期</td>
<td>购置价格</td>
<td>设备状态</td>
<td>设备描述</td>
<td>设备图片URL</td>
</tr>
</tbody>
</table>
<p>状态枚举：</p>
<ul>
<li>available - 可用</li>
<li>in_use - 使用中</li>
<li>maintenance - 维修中</li>
<li>scrapped - 已报废</li>
</ul>
<h3 id="6-6-预约记录表">6.6 预约记录表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>设备ID</th>
<th>预约人ID</th>
<th>预约提交时间</th>
<th>开始时间</th>
<th>结束时间</th>
<th>状态</th>
<th>目的</th>
<th>管理员ID</th>
<th>审批时间</th>
<th>审批意见</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>int(32)</td>
<td>int(32)</td>
<td>date</td>
<td>date</td>
<td>date</td>
<td>enum</td>
<td>text</td>
<td>int(32)</td>
<td>date</td>
<td>text</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空、外键</td>
<td>非空、外键</td>
<td>默认当前时间</td>
<td>非空</td>
<td>非空</td>
<td>默认“待审批”</td>
<td>/</td>
<td>外键</td>
<td>/</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>预约记录ID</td>
<td>预约设备ID</td>
<td>预约人ID</td>
<td>提交预约的时间</td>
<td>预计开始使用时间</td>
<td>预计结束使用时间</td>
<td>预约状态</td>
<td>用途说明</td>
<td>审批管理员ID</td>
<td>审批时间</td>
<td>审批意见</td>
</tr>
</tbody>
</table>
<p><strong>状态枚举值</strong>：</p>
<ul>
<li>pending - 待审批</li>
<li>approved - 已批准</li>
<li>rejected - 已拒绝</li>
<li>in_use - 使用中</li>
<li>completed - 已完成</li>
<li>cancelled - 已取消</li>
</ul>
<h3 id="6-7-使用记录表">6.7 使用记录表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>关联预约ID</th>
<th>开始使用时间</th>
<th>结束使用时间</th>
<th>状态</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>int(32)</td>
<td>date</td>
<td>date</td>
<td>enum</td>
<td>text</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空、外键</td>
<td>非空</td>
<td>/</td>
<td>默认“使用中”</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>使用记录ID</td>
<td>预约记录ID</td>
<td>开始使用的时间</td>
<td>结束使用的时间</td>
<td>使用状态</td>
<td>使用备注</td>
</tr>
</tbody>
</table>
<p><strong>状态枚举值</strong>：</p>
<ul>
<li>in_use - 使用中</li>
<li>completed - 已完成</li>
<li>cancelled - 已取消</li>
</ul>
<h3 id="6-8-报修记录表">6.8 报修记录表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>设备ID</th>
<th>报修人ID</th>
<th>管理员ID</th>
<th>维修人ID</th>
<th>问题标题</th>
<th>问题描述</th>
<th>优先级</th>
<th>状态</th>
<th>图片</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>int(32)</td>
<td>int(32)</td>
<td>int(32)</td>
<td>int(32)</td>
<td>varchar(20)</td>
<td>text</td>
<td>enum</td>
<td>enum</td>
<td>varchar(255)</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空、外键</td>
<td>非空、外键</td>
<td>外键</td>
<td>外键</td>
<td>非空</td>
<td>/</td>
<td>默认“中”</td>
<td>默认“待处理”</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>保修记录ID</td>
<td>设备ID</td>
<td>保修人ID</td>
<td>管理员ID</td>
<td>维修人ID</td>
<td>问题标题</td>
<td>问题详细描述</td>
<td>处理优先级</td>
<td>维修状态</td>
<td>故障图片URL</td>
</tr>
</tbody>
</table>
<p><strong>优先级枚举值</strong>：</p>
<ul>
<li>low - 低</li>
<li>medium - 中</li>
<li>high - 高</li>
<li>urgent - 紧急</li>
</ul>
<p><strong>状态枚举值</strong>：</p>
<ul>
<li>pending - 待处理</li>
<li>assigned - 已分配</li>
<li>in_progress - 处理中</li>
<li>completed - 已完成</li>
<li>cancelled - 已取消</li>
</ul>
<h3 id="6-9-报修进度表">6.9 报修进度表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>报修记录ID</th>
<th>操作人身份</th>
<th>操作人ID</th>
<th>状态</th>
<th>备注</th>
<th>创建时间</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>int(32)</td>
<td>enum</td>
<td>int(32)</td>
<td>enum</td>
<td>text</td>
<td>date</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空、外键</td>
<td>非空</td>
<td>非空</td>
<td>非空</td>
<td>/</td>
<td>默认当前时间</td>
</tr>
<tr>
<td>说明</td>
<td>进度记录ID</td>
<td>报修记录ID</td>
<td>操作人的身份</td>
<td>操作人ID</td>
<td>变更后的状态</td>
<td>备注说明</td>
<td>创建时间</td>
</tr>
</tbody>
</table>
<p><strong>身份枚举值</strong>：</p>
<ul>
<li>normal - 普通用户</li>
<li>admin - 管理员</li>
<li>maintenance - 维修人员</li>
</ul>
<h3 id="6-10-生产厂商表">6.10 生产厂商表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>厂商名称</th>
<th>联系人</th>
<th>电话</th>
<th>地址</th>
<th>网站</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>varchar(100)</td>
<td>varchar(20)</td>
<td>varchar(30)</td>
<td>text</td>
<td>varchar(255)</td>
<td>text</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空</td>
<td>/</td>
<td>/</td>
<td>/</td>
<td>/</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>厂商ID</td>
<td>厂商名称</td>
<td>联系人名字</td>
<td>联系电话</td>
<td>厂商详细地址</td>
<td>厂商的网站</td>
<td>厂商描述</td>
</tr>
</tbody>
</table>
<h3 id="6-11-零件表">6.11 零件表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>零件名称</th>
<th>零件分类</th>
<th>计量单位</th>
<th>零件描述</th>
<th>零件图片</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>varchar(20)</td>
<td>enum</td>
<td>varchar(10)</td>
<td>text</td>
<td>varchar(255)</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空</td>
<td>/</td>
<td>默认“个”</td>
<td>/</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>零件ID</td>
<td>零件名称</td>
<td>零件的类型</td>
<td>零件的计量单位</td>
<td>零件的相关描述</td>
<td>零件图片的URL</td>
</tr>
</tbody>
</table>
<p><strong>状态枚举值</strong>：</p>
<ul>
<li>active - 正常</li>
<li>discontinued - 已停产</li>
</ul>
<h3 id="6-12-零件-生产厂商关联表">6.12 零件-生产厂商关联表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>零件ID</th>
<th>厂商ID</th>
<th>单价</th>
<th>交货周期</th>
<th>是否为首选供应商</th>
<th>质量评分</th>
<th>备注说明</th>
<th>状态</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>int(32)</td>
<td>int(32)</td>
<td>decimal(10,2)</td>
<td>int(32)</td>
<td>boolean</td>
<td>decimal(3,2)</td>
<td>text</td>
<td>enum</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空、外键</td>
<td>非空、外键</td>
<td>非空</td>
<td>/</td>
<td>默认否</td>
<td>/</td>
<td>/</td>
<td>默认“启用”</td>
</tr>
<tr>
<td>说明</td>
<td>关联ID</td>
<td>零件ID</td>
<td>厂商的ID</td>
<td>零件的单价</td>
<td>交货时长</td>
<td>是否为首选供应商</td>
<td>0-5.00质量评分</td>
<td>相关备注说明</td>
<td>关联状态</td>
</tr>
</tbody>
</table>
<h3 id="6-13-采购工单表">6.13 采购工单表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>报修ID</th>
<th>零件-厂商关联ID</th>
<th>原因</th>
<th>紧急程度</th>
<th>期望到货时间</th>
<th>状态</th>
<th>审批人ID</th>
<th>审批时间</th>
<th>审批意见</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>int(32)</td>
<td>int(32)</td>
<td>text</td>
<td>enum</td>
<td>date</td>
<td>enum</td>
<td>int(32)</td>
<td>date</td>
<td>text</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>外键</td>
<td>非空、外键</td>
<td>非空</td>
<td>默认“中”</td>
<td>/</td>
<td>默认“待审批”</td>
<td>外键</td>
<td>/</td>
<td>/</td>
</tr>
<tr>
<td>说明</td>
<td>采购工单ID</td>
<td>关联的维修请求ID</td>
<td>零件-厂商关联ID</td>
<td>采购申请原因</td>
<td>本次采购的紧急程度</td>
<td>期望到货时间</td>
<td>审批状态</td>
<td>审批采购人的ID</td>
<td>进行审批的时间</td>
<td>审批意见</td>
</tr>
</tbody>
</table>
<p><strong>紧急程度枚举值</strong>：</p>
<ul>
<li>low - 低</li>
<li>medium - 中</li>
<li>high - 高</li>
<li>urgent - 紧急</li>
</ul>
<p><strong>状态枚举值</strong>：</p>
<ul>
<li>pending - 待审批</li>
<li>approved - 已批准</li>
<li>rejected - 已拒绝</li>
<li>cancelled - 已取消</li>
</ul>
<h3 id="6-14-采购工单进度记录表">6.14 采购工单进度记录表</h3>
<table>
<thead>
<tr>
<th></th>
<th>ID</th>
<th>采购工单ID</th>
<th>状态</th>
<th>操作人ID</th>
<th>操作人身份</th>
<th>备注说明</th>
<th>创建时间</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据类型</td>
<td>int(32)</td>
<td>int(32)</td>
<td>enum</td>
<td>int(32)</td>
<td>enum</td>
<td>text</td>
<td>date</td>
</tr>
<tr>
<td>值约束</td>
<td>主键、自增</td>
<td>非空、外键</td>
<td>非空</td>
<td>非空</td>
<td>/</td>
<td>/</td>
<td>默认当前时间</td>
</tr>
<tr>
<td>说明</td>
<td>进度记录ID</td>
<td>采购工单ID</td>
<td>变更后的状态</td>
<td>进行操作的人的ID</td>
<td>操作人的身份</td>
<td>备注说明</td>
<td>创建时间</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="七、触发器与存储过程的设计与实现说明">七、触发器与存储过程的设计与实现说明</h2>
<h3 id="7-1-触发器系统设计">7.1 触发器系统设计</h3>
<p>本项目采用触发器机制自动维护数据的一致性，遵从最小干预原则、状态同步原则、审计追踪原则、性能优先原则。在具体实现中定义了辅助工具来提高代码复用性。</p>
<h4 id="7-1-1-辅助函数：设备状态计算">7.1.1 辅助函数：设备状态计算</h4>
<p><strong>函数名称</strong>：<code>fn_calc_equipment_status</code></p>
<p><strong>功能</strong>：根据预约和维修记录计算设备当前的正确状态</p>
<p><strong>状态优先级</strong>：<code>maintenance</code> &gt; <code>in_use</code> &gt; <code>available</code></p>
<p><strong>关键特性</strong>：</p>
<ul>
<li>使用 <code>DETERMINISTIC</code> 声明函数确定性，对于相同的输入产生相同的输出</li>
<li><code>READS SQL DATA</code>声明表示该函数只读数据，不修改状态</li>
<li>使用 <code>EXISTS</code> 子查询代替 <code>COUNT(*)</code>，提前退出提高效率</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> fn_calc_equipment_status(p_equipment_id <span class="type">INT</span>) </span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line"><span class="keyword">DETERMINISTIC</span></span><br><span class="line"><span class="keyword">READS</span> <span class="keyword">SQL</span> DATA</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 优先级：maintenance &gt; in_use &gt; available</span></span><br><span class="line">    <span class="comment">-- 检查是否有未完成的维修任务</span></span><br><span class="line">    IF <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> warranty_records </span><br><span class="line">               <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> p_equipment_id </span><br><span class="line">               <span class="keyword">AND</span> status <span class="keyword">IN</span> (<span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>)) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> v_status <span class="operator">=</span> <span class="string">&#x27;maintenance&#x27;</span>;</span><br><span class="line">    <span class="comment">-- 检查是否正在使用中</span></span><br><span class="line">    ELSEIF <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> reservation_records </span><br><span class="line">                   <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> p_equipment_id </span><br><span class="line">                   <span class="keyword">AND</span> status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span>) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> v_status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span>;</span><br><span class="line">    <span class="comment">-- 默认可用</span></span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">        <span class="keyword">SET</span> v_status <span class="operator">=</span> <span class="string">&#x27;available&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">RETURN</span> v_status;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h4 id="7-1-2-辅助存储过程：同步设备状态">7.1.2 辅助存储过程：同步设备状态</h4>
<p><strong>过程名</strong>：<code>sp_sync_equipment_status</code></p>
<p><strong>功能</strong>：统一的设备状态同步逻辑，供触发器调用</p>
<p><strong>关键设计</strong>：</p>
<ul>
<li><strong>避免无效更新</strong>：更新只在状态真正变化时进行update，减少写操作</li>
<li><strong>统一错误处理</strong>：使用 <code>SIGNAL</code> 抛出自定义错误，防止报废设备的状态被修改</li>
<li><strong>统一入口</strong>：所有触发器都通过本过程同步状态，保证逻辑一致性</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_sync_equipment_status(<span class="keyword">IN</span> p_equipment_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_new_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_current_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取当前状态</span></span><br><span class="line">    <span class="keyword">SELECT</span> status <span class="keyword">INTO</span> v_current_status <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> p_equipment_id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 如果设备已报废，不改变状态</span></span><br><span class="line">    IF v_current_status <span class="operator">=</span> <span class="string">&#x27;scrapped&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        SIGNAL <span class="keyword">SQLSTATE</span> <span class="string">&#x27;45000&#x27;</span> <span class="keyword">SET</span> MESSAGE_TEXT <span class="operator">=</span> <span class="string">&#x27;设备已报废，无法操作&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 计算新状态</span></span><br><span class="line">    <span class="keyword">SET</span> v_new_status <span class="operator">=</span> fn_calc_equipment_status(p_equipment_id);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 仅当状态变化时更新</span></span><br><span class="line">    IF v_new_status <span class="operator">!=</span> v_current_status <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> equipment <span class="keyword">SET</span> status <span class="operator">=</span> v_new_status <span class="keyword">WHERE</span> id <span class="operator">=</span> p_equipment_id;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h4 id="7-1-3-预约相关触发器">7.1.3 预约相关触发器</h4>
<h5 id="7-1-3-1-预约状态变更触发器">7.1.3.1 预约状态变更触发器</h5>
<p><strong>触发器名称</strong>：<code>trg_reservation_status_change</code></p>
<p><strong>触发时机</strong>：<code>AFTER UPDATE ON reservation_records</code></p>
<p><strong>触发条件</strong>：预约状态发生变化</p>
<p><strong>功能</strong>：</p>
<ul>
<li>预约开始使用时，设备状态变更为 <code>in_use</code></li>
<li>预约完成/取消时，检查并恢复设备状态为<code>completed/cancelled/rejected</code></li>
</ul>
<p><strong>关键设计</strong>：</p>
<ul>
<li><strong>状态检测</strong>：<code>NEW.status != OLD.status</code> 表示仅当状态变化时处理，可以避免不必要的触发</li>
<li><strong>状态恢复</strong>：同时检查预约和维修记录，只有在没有其他占用时才恢复 <code>available</code></li>
<li><strong>跨表检查</strong>：同时检查预约和维修记录防止状态冲突，确保数据一致性</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_reservation_status_change</span><br><span class="line">AFTER <span class="keyword">UPDATE</span> <span class="keyword">ON</span> reservation_records</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 仅当状态发生变化时处理</span></span><br><span class="line">    IF NEW.status <span class="operator">!=</span> OLD.status <span class="keyword">THEN</span></span><br><span class="line">        <span class="comment">-- 状态变为 in_use：设备开始使用</span></span><br><span class="line">        IF NEW.status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">            <span class="keyword">UPDATE</span> equipment <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.equipment_id;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">-- 状态变为 completed/cancelled/rejected：检查并恢复设备状态</span></span><br><span class="line">        ELSEIF NEW.status <span class="keyword">IN</span> (<span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;cancelled&#x27;</span>, <span class="string">&#x27;rejected&#x27;</span>) </span><br><span class="line">               <span class="keyword">AND</span> OLD.status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">            <span class="comment">-- 检查是否还有其他使用中的预约或维修任务</span></span><br><span class="line">            IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">                <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> reservation_records </span><br><span class="line">                <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> NEW.equipment_id </span><br><span class="line">                  <span class="keyword">AND</span> status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span> </span><br><span class="line">                  <span class="keyword">AND</span> id <span class="operator">!=</span> NEW.id</span><br><span class="line">            ) <span class="keyword">AND</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">                <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> warranty_records </span><br><span class="line">                <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> NEW.equipment_id </span><br><span class="line">                  <span class="keyword">AND</span> status <span class="keyword">IN</span> (<span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>)</span><br><span class="line">            ) <span class="keyword">THEN</span></span><br><span class="line">                <span class="keyword">UPDATE</span> equipment <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;available&#x27;</span> </span><br><span class="line">                <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.equipment_id;</span><br><span class="line">            <span class="keyword">END</span> IF;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-1-3-2-预约删除触发器">7.1.3.2 预约删除触发器</h5>
<p><strong>触发器名称</strong>：<code>trg_reservation_delete</code></p>
<p><strong>触发时机</strong>：<code>AFTER DELETE ON reservation_records</code></p>
<p><strong>功能</strong>：删除正在使用的预约记录时，自动恢复设备状态</p>
<p><strong>应用场景</strong>：管理员清楚异常预约记录时自动维护设备状态的一致性</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_reservation_delete</span><br><span class="line">AFTER <span class="keyword">DELETE</span> <span class="keyword">ON</span> reservation_records</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 仅当删除的是使用中的预约时处理</span></span><br><span class="line">    IF OLD.status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">            <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> reservation_records </span><br><span class="line">            <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> OLD.equipment_id </span><br><span class="line">              <span class="keyword">AND</span> status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span></span><br><span class="line">        ) <span class="keyword">AND</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">            <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> warranty_records </span><br><span class="line">            <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> OLD.equipment_id </span><br><span class="line">              <span class="keyword">AND</span> status <span class="keyword">IN</span> (<span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>)</span><br><span class="line">        ) <span class="keyword">THEN</span></span><br><span class="line">            <span class="keyword">UPDATE</span> equipment <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;available&#x27;</span> </span><br><span class="line">            <span class="keyword">WHERE</span> id <span class="operator">=</span> OLD.equipment_id;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h4 id="7-1-4-维修相关触发器">7.1.4 维修相关触发器</h4>
<h5 id="7-1-4-1-维修记录创建触发器">7.1.4.1 维修记录创建触发器</h5>
<p><strong>触发器名称</strong>：<code>trg_warranty_create</code></p>
<p><strong>触发时机</strong>：<code>AFTER INSERT ON warranty_records</code></p>
<p><strong>功能</strong>：</p>
<ul>
<li>创建维修记录时将设备状态自动设置为<code>maintenance</code></li>
<li>自动创建维修进度记录</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_warranty_create</span><br><span class="line">AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> warranty_records</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_current_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取设备当前状态</span></span><br><span class="line">    <span class="keyword">SELECT</span> status <span class="keyword">INTO</span> v_current_status </span><br><span class="line">    <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.equipment_id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 只有非报废设备才更新状态为维修中</span></span><br><span class="line">    IF v_current_status <span class="operator">!=</span> <span class="string">&#x27;scrapped&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> equipment <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;maintenance&#x27;</span> </span><br><span class="line">        <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.equipment_id;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 自动记录维修进度（报修创建）</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> warranty_progress (</span><br><span class="line">        warranty_id, actor_role, actor_id, status, note</span><br><span class="line">    ) <span class="keyword">VALUES</span> (</span><br><span class="line">        NEW.id, <span class="string">&#x27;normal&#x27;</span>, NEW.reported_by, <span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;用户提交报修&#x27;</span></span><br><span class="line">    );</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-1-4-2-维修状态变更触发器">7.1.4.2 维修状态变更触发器</h5>
<p><strong>触发器名称</strong>：<code>trg_warranty_status_change</code></p>
<p><strong>触发时机</strong>：<code>AFTER UPDATE ON warranty_records</code></p>
<p><strong>智能状态恢复</strong>：维修完成后，根据是否有使用中的预约，将设备的状态恢复为 <code>in_use</code> 或 <code>available</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_warranty_status_change</span><br><span class="line">AFTER <span class="keyword">UPDATE</span> <span class="keyword">ON</span> warranty_records</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 仅当状态发生变化时处理</span></span><br><span class="line">    IF NEW.status <span class="operator">!=</span> OLD.status <span class="keyword">THEN</span></span><br><span class="line">        <span class="comment">-- 状态变为 in_progress：确保设备状态为maintenance</span></span><br><span class="line">        IF NEW.status <span class="operator">=</span> <span class="string">&#x27;in_progress&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">            <span class="keyword">UPDATE</span> equipment <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;maintenance&#x27;</span> </span><br><span class="line">            <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.equipment_id;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">-- 状态变为 completed/cancelled：检查并恢复设备状态</span></span><br><span class="line">        ELSEIF NEW.status <span class="keyword">IN</span> (<span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;cancelled&#x27;</span>) <span class="keyword">THEN</span></span><br><span class="line">            IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">                <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> warranty_records </span><br><span class="line">                <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> NEW.equipment_id </span><br><span class="line">                  <span class="keyword">AND</span> status <span class="keyword">IN</span> (<span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>) </span><br><span class="line">                  <span class="keyword">AND</span> id <span class="operator">!=</span> NEW.id</span><br><span class="line">            ) <span class="keyword">THEN</span></span><br><span class="line">                <span class="comment">-- 检查是否有使用中的预约</span></span><br><span class="line">                IF <span class="keyword">EXISTS</span> (</span><br><span class="line">                    <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> reservation_records </span><br><span class="line">                    <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> NEW.equipment_id </span><br><span class="line">                      <span class="keyword">AND</span> status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span></span><br><span class="line">                ) <span class="keyword">THEN</span></span><br><span class="line">                    <span class="keyword">UPDATE</span> equipment <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span> </span><br><span class="line">                    <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.equipment_id;</span><br><span class="line">                <span class="keyword">ELSE</span></span><br><span class="line">                    <span class="keyword">UPDATE</span> equipment <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;available&#x27;</span> </span><br><span class="line">                    <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.equipment_id;</span><br><span class="line">                <span class="keyword">END</span> IF;</span><br><span class="line">            <span class="keyword">END</span> IF;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-1-4-3-维修删除触发">7.1.4.3 维修删除触发</h5>
<p><strong>触发器名称</strong>：<code>trg_warranty_delete</code></p>
<p><strong>触发时机</strong>：<code>AFTER DELETE ON warranty_records</code></p>
<p><strong>功能</strong>：当删除维修记录时，检查该设备是否还有其他维修任务或使用中的预约，恢复设备状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_warranty_delete</span><br><span class="line">AFTER <span class="keyword">DELETE</span> <span class="keyword">ON</span> warranty_records</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 检查是否还有其他维修任务</span></span><br><span class="line">    IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> warranty_records </span><br><span class="line">        <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> OLD.equipment_id </span><br><span class="line">          <span class="keyword">AND</span> status <span class="keyword">IN</span> (<span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>)</span><br><span class="line">    ) <span class="keyword">THEN</span></span><br><span class="line">        <span class="comment">-- 没有维修任务了，检查是否有使用中的预约</span></span><br><span class="line">        IF <span class="keyword">EXISTS</span> (</span><br><span class="line">            <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> reservation_records </span><br><span class="line">            <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> OLD.equipment_id </span><br><span class="line">              <span class="keyword">AND</span> status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span></span><br><span class="line">        ) <span class="keyword">THEN</span></span><br><span class="line">            <span class="comment">-- 有预约在使用，恢复为in_use</span></span><br><span class="line">            <span class="keyword">UPDATE</span> equipment <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span> </span><br><span class="line">            <span class="keyword">WHERE</span> id <span class="operator">=</span> OLD.equipment_id;</span><br><span class="line">        <span class="keyword">ELSE</span></span><br><span class="line">            <span class="comment">-- 完全空闲，恢复为available</span></span><br><span class="line">            <span class="keyword">UPDATE</span> equipment <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;available&#x27;</span> </span><br><span class="line">            <span class="keyword">WHERE</span> id <span class="operator">=</span> OLD.equipment_id;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="comment">-- 如果还有其他维修任务，保持maintenance状态，不做任何操作</span></span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h4 id="7-1-5-采购相关触发器">7.1.5 采购相关触发器</h4>
<h5 id="7-1-5-1-采购状态变更触发器">7.1.5.1 采购状态变更触发器</h5>
<p><strong>触发器名称</strong>：<code>trg_purchase_status_change</code></p>
<p><strong>触发时机</strong>：<code>AFTER UPDATE ON purchase_orders</code></p>
<p><strong>功能</strong>：自动记录采购工单的状态变更，支持全流程追溯</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_purchase_status_change</span><br><span class="line">AFTER <span class="keyword">UPDATE</span> <span class="keyword">ON</span> purchase_orders</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 仅当状态发生变化时处理</span></span><br><span class="line">    IF NEW.status <span class="operator">!=</span> OLD.status <span class="keyword">THEN</span></span><br><span class="line">        <span class="comment">-- 记录状态变更进度</span></span><br><span class="line">        <span class="keyword">INSERT INTO</span> purchase_order_progress (</span><br><span class="line">            purchase_order_id, status, operator_id, note</span><br><span class="line">        ) <span class="keyword">VALUES</span> (</span><br><span class="line">            NEW.id, </span><br><span class="line">            NEW.status, </span><br><span class="line">            <span class="built_in">COALESCE</span>(NEW.approver_id, NEW.requester_id), </span><br><span class="line">            <span class="keyword">CASE</span> </span><br><span class="line">                <span class="keyword">WHEN</span> NEW.status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span> <span class="keyword">THEN</span> </span><br><span class="line">                    CONCAT(<span class="string">&#x27;审批通过: &#x27;</span>, IFNULL(NEW.approval_note, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                <span class="keyword">WHEN</span> NEW.status <span class="operator">=</span> <span class="string">&#x27;rejected&#x27;</span> <span class="keyword">THEN</span> </span><br><span class="line">                    CONCAT(<span class="string">&#x27;审批拒绝: &#x27;</span>, IFNULL(NEW.approval_note, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                <span class="keyword">ELSE</span> NEW.approval_note</span><br><span class="line">            <span class="keyword">END</span></span><br><span class="line">        );</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-1-5-2-采购创建触发器">7.1.5.2 采购创建触发器</h5>
<p><strong>触发器名称</strong>：<code>trg_purchase_create</code></p>
<p><strong>触发时机</strong>：<code>AFTER INSERT ON purchase_orders</code></p>
<p><strong>功能</strong>：在创建新的采购工单时记录采购工单的初始状态，支持流程追溯</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_purchase_create</span><br><span class="line">AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> purchase_orders</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 自动记录采购工单的初始进度</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> purchase_order_progress (</span><br><span class="line">        purchase_order_id, </span><br><span class="line">        status, </span><br><span class="line">        operator_id, </span><br><span class="line">        note</span><br><span class="line">    ) <span class="keyword">VALUES</span> (</span><br><span class="line">        NEW.id,              <span class="comment">-- 新创建的工单ID</span></span><br><span class="line">        <span class="string">&#x27;pending&#x27;</span>,           <span class="comment">-- 初始状态：待审批</span></span><br><span class="line">        NEW.requester_id,    <span class="comment">-- 操作人：申请人</span></span><br><span class="line">        <span class="string">&#x27;创建采购申请&#x27;</span>        <span class="comment">-- 操作备注</span></span><br><span class="line">    );</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h4 id="7-1-6-使用记录触发器">7.1.6 使用记录触发器</h4>
<p><strong>触发器名称</strong>：<code>trg_usage_status_change</code></p>
<p><strong>触发时机</strong>：<code>AFTER UPDATE ON usage_records</code></p>
<p><strong>功能</strong>：使用记录状态变化时，级联更新预约状态，即将使用状态的变化同步到预约记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_usage_status_change</span><br><span class="line">AFTER <span class="keyword">UPDATE</span> <span class="keyword">ON</span> usage_records</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 使用完成时更新预约状态</span></span><br><span class="line">    IF NEW.usage_status <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span> <span class="keyword">AND</span> OLD.usage_status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> reservation_records <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span> </span><br><span class="line">        <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.reservation_id;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">-- 使用取消时也更新预约状态</span></span><br><span class="line">    ELSEIF NEW.usage_status <span class="operator">=</span> <span class="string">&#x27;cancelled&#x27;</span> <span class="keyword">AND</span> OLD.usage_status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> reservation_records <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;cancelled&#x27;</span> </span><br><span class="line">        <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.reservation_id;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h3 id="7-2-存储过程系统设计">7.2 存储过程系统设计</h3>
<p>本项目的存储过程设计原则包括：事务完整性、并发安全性、参数校验、错误处理、友好反馈</p>
<h4 id="7-2-1-预约管理存储过程">7.2.1 预约管理存储过程</h4>
<h5 id="7-2-1-1-预约审批存储过程">7.2.1.1 预约审批存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_approve_reservation</code></p>
<p><strong>输入参数</strong>：</p>
<ul>
<li><code>p_reservation_id INT</code> - 预约记录ID</li>
<li><code>p_approver_id INT</code> - 审批人ID</li>
<li><code>p_approved BOOLEAN</code> - 是否批准（TRUE=批准，FALSE=拒绝）</li>
<li><code>p_note VARCHAR(500)</code> - 审批意见</li>
</ul>
<p><strong>输出参数</strong>：</p>
<ul>
<li><code>p_result INT</code> - 操作结果码</li>
<li><code>p_message VARCHAR(200)</code> - 结果消息</li>
</ul>
<p><strong>功能</strong>：检查设备状态是否为可预约，管理员审批或拒绝用户的预约申请，包含时间冲突检测</p>
<p><strong>关键设计</strong>：</p>
<ul>
<li><strong>行级锁</strong>：<code>FOR UPDATE</code> 防止并发审批冲突</li>
<li><strong>时间区间冲突算法</strong>：<code>start1 &lt; end2 AND end1 &gt; start2</code></li>
<li><strong>错误消息</strong>：每种失败情况都有明确清晰地提示</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_approve_reservation(</span><br><span class="line">    <span class="keyword">IN</span> p_reservation_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_approver_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_approved <span class="type">BOOLEAN</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_note <span class="type">VARCHAR</span>(<span class="number">500</span>),</span><br><span class="line">    <span class="keyword">OUT</span> p_result <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">OUT</span> p_message <span class="type">VARCHAR</span>(<span class="number">200</span>)</span><br><span class="line">)</span><br><span class="line">proc_label: <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_equipment_id <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_start_time DATETIME;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_end_time DATETIME;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_conflict_count <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_equipment_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 统一异常处理</span></span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-99</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;系统错误，请稍后重试&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 参数验证</span></span><br><span class="line">    IF p_reservation_id <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> p_reservation_id <span class="operator">&lt;=</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;无效的预约ID&#x27;</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取预约信息（加锁，防止并发冲突）</span></span><br><span class="line">    <span class="keyword">SELECT</span> equipment_id, expected_start_time, expected_end_time, status</span><br><span class="line">    <span class="keyword">INTO</span> v_equipment_id, v_start_time, v_end_time, v_status</span><br><span class="line">    <span class="keyword">FROM</span> reservation_records</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_reservation_id</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查预约状态</span></span><br><span class="line">    IF v_status <span class="operator">!=</span> <span class="string">&#x27;pending&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-3</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(<span class="string">&#x27;预约状态不允许审批: &#x27;</span>, v_status);</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 如果拒绝，直接处理</span></span><br><span class="line">    IF <span class="keyword">NOT</span> p_approved <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> reservation_records</span><br><span class="line">        <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;rejected&#x27;</span>,</span><br><span class="line">            approver_admin_id <span class="operator">=</span> p_approver_id,</span><br><span class="line">            approval_time <span class="operator">=</span> NOW(),</span><br><span class="line">            approval_note <span class="operator">=</span> p_note</span><br><span class="line">        <span class="keyword">WHERE</span> id <span class="operator">=</span> p_reservation_id;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;预约已拒绝&#x27;</span>;</span><br><span class="line">        <span class="keyword">COMMIT</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查设备状态</span></span><br><span class="line">    <span class="keyword">SELECT</span> status <span class="keyword">INTO</span> v_equipment_status </span><br><span class="line">    <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> v_equipment_id;</span><br><span class="line">    </span><br><span class="line">    IF v_equipment_status <span class="operator">=</span> <span class="string">&#x27;scrapped&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-4</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;设备已报废，无法预约&#x27;</span>;</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 时间冲突检测（核心算法）</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">INTO</span> v_conflict_count</span><br><span class="line">    <span class="keyword">FROM</span> reservation_records</span><br><span class="line">    <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> v_equipment_id</span><br><span class="line">      <span class="keyword">AND</span> id <span class="operator">!=</span> p_reservation_id</span><br><span class="line">      <span class="keyword">AND</span> status <span class="keyword">IN</span> (<span class="string">&#x27;approved&#x27;</span>, <span class="string">&#x27;in_use&#x27;</span>)</span><br><span class="line">      <span class="keyword">AND</span> expected_start_time <span class="operator">&lt;</span> v_end_time </span><br><span class="line">      <span class="keyword">AND</span> expected_end_time <span class="operator">&gt;</span> v_start_time;</span><br><span class="line">    </span><br><span class="line">    IF v_conflict_count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-5</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;该时间段已有其他预约，存在时间冲突&#x27;</span>;</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 执行审批</span></span><br><span class="line">    <span class="keyword">UPDATE</span> reservation_records</span><br><span class="line">    <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span>,</span><br><span class="line">        approver_admin_id <span class="operator">=</span> p_approver_id,</span><br><span class="line">        approval_time <span class="operator">=</span> NOW(),</span><br><span class="line">        approval_note <span class="operator">=</span> p_note</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_reservation_id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;预约审批通过&#x27;</span>;</span><br><span class="line">    <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-2-1-2-开始使用设备存储过程">7.2.1.2 开始使用设备存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_start_using_equipment</code></p>
<p><strong>输入参数</strong>：</p>
<ul>
<li><code>p_reservation_id INT</code> - 预约记录ID</li>
<li><code>p_user_id INT</code> - 用户ID</li>
</ul>
<p><strong>输出参数</strong>：</p>
<ul>
<li><code>p_result INT</code> - 操作结果码</li>
<li><code>p_message VARCHAR(200)</code> - 结果消息</li>
</ul>
<p><strong>功能</strong>：验证用户身份、检查预约状态、自动创建使用记录</p>
<p><strong>关键设计</strong>：</p>
<ul>
<li><strong>提前15分钟容忍</strong>：<code>DATE_SUB(v_start_time, INTERVAL 15 MINUTE)</code></li>
<li><strong>自动过期处理</strong>：超时预约自动取消</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_start_using_equipment(</span><br><span class="line">    <span class="keyword">IN</span> p_reservation_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_user_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">OUT</span> p_result <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">OUT</span> p_message <span class="type">VARCHAR</span>(<span class="number">200</span>)</span><br><span class="line">)</span><br><span class="line">proc_label: <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_equipment_id <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_reservation_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_equipment_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_start_time DATETIME;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_end_time DATETIME;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_user_id <span class="type">INT</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-99</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;系统错误，请稍后重试&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取预约和设备信息（联表查询+加锁）</span></span><br><span class="line">    <span class="keyword">SELECT</span> r.equipment_id, r.status, r.expected_start_time, </span><br><span class="line">           r.expected_end_time, r.user_id, e.status</span><br><span class="line">    <span class="keyword">INTO</span> v_equipment_id, v_reservation_status, v_start_time, </span><br><span class="line">         v_end_time, v_user_id, v_equipment_status</span><br><span class="line">    <span class="keyword">FROM</span> reservation_records r</span><br><span class="line">    <span class="keyword">JOIN</span> equipment e <span class="keyword">ON</span> r.equipment_id <span class="operator">=</span> e.id</span><br><span class="line">    <span class="keyword">WHERE</span> r.id <span class="operator">=</span> p_reservation_id</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 验证用户身份</span></span><br><span class="line">    IF p_user_id <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">AND</span> p_user_id <span class="operator">!=</span> v_user_id <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-3</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;您不是该预约的申请人&#x27;</span>;</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查预约状态</span></span><br><span class="line">    IF v_reservation_status <span class="operator">!=</span> <span class="string">&#x27;approved&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-4</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(<span class="string">&#x27;预约状态不允许开始使用: &#x27;</span>, v_reservation_status);</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 时间窗口检查（允许提前15分钟）</span></span><br><span class="line">    IF NOW() <span class="operator">&lt;</span> DATE_SUB(v_start_time, <span class="type">INTERVAL</span> <span class="number">15</span> <span class="keyword">MINUTE</span>) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-6</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(</span><br><span class="line">            <span class="string">&#x27;还未到预约开始时间，最早可在 &#x27;</span>, </span><br><span class="line">            DATE_FORMAT(DATE_SUB(v_start_time, <span class="type">INTERVAL</span> <span class="number">15</span> <span class="keyword">MINUTE</span>), </span><br><span class="line">                        <span class="string">&#x27;%Y-%m-%d %H:%i&#x27;</span>), </span><br><span class="line">            <span class="string">&#x27; 开始使用&#x27;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查是否超过结束时间</span></span><br><span class="line">    IF NOW() <span class="operator">&gt;</span> v_end_time <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-7</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;预约已过期，请重新预约&#x27;</span>;</span><br><span class="line">        <span class="comment">-- 自动标记为过期</span></span><br><span class="line">        <span class="keyword">UPDATE</span> reservation_records <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;cancelled&#x27;</span> </span><br><span class="line">        <span class="keyword">WHERE</span> id <span class="operator">=</span> p_reservation_id;</span><br><span class="line">        <span class="keyword">COMMIT</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 更新预约状态（触发器会自动更新设备状态）</span></span><br><span class="line">    <span class="keyword">UPDATE</span> reservation_records <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span> </span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_reservation_id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 创建使用记录</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> usage_records (</span><br><span class="line">        reservation_id, usage_start_time, usage_status</span><br><span class="line">    ) <span class="keyword">VALUES</span> (</span><br><span class="line">        p_reservation_id, NOW(), <span class="string">&#x27;in_use&#x27;</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;开始使用成功&#x27;</span>;</span><br><span class="line">    <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-2-1-3-完成使用设备存储过程">7.2.1.3 完成使用设备存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_complete_using_equipment</code></p>
<p><strong>功能</strong>：验证用户身份、检查预约状态、自动计算使用时长并更新使用记录和预约状态</p>
<p><strong>关键设计</strong>：使用 <code>TIMESTAMPDIFF</code> 自动计算使用时长，并追加到备注中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_complete_using_equipment(</span><br><span class="line">    <span class="keyword">IN</span> p_reservation_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_user_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_usage_note <span class="type">VARCHAR</span>(<span class="number">500</span>),</span><br><span class="line">    <span class="keyword">OUT</span> p_result <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">OUT</span> p_message <span class="type">VARCHAR</span>(<span class="number">200</span>)</span><br><span class="line">)</span><br><span class="line">proc_label: <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_reservation_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_user_id <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_usage_id <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_start_time DATETIME;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_duration_minutes <span class="type">INT</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-99</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;系统错误，请稍后重试&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取使用记录</span></span><br><span class="line">    <span class="keyword">SELECT</span> id, usage_start_time <span class="keyword">INTO</span> v_usage_id, v_start_time</span><br><span class="line">    <span class="keyword">FROM</span> usage_records</span><br><span class="line">    <span class="keyword">WHERE</span> reservation_id <span class="operator">=</span> p_reservation_id </span><br><span class="line">      <span class="keyword">AND</span> usage_status <span class="operator">=</span> <span class="string">&#x27;in_use&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    IF v_usage_id <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-5</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;使用记录不存在&#x27;</span>;</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 计算使用时长（分钟）</span></span><br><span class="line">    <span class="keyword">SET</span> v_duration_minutes <span class="operator">=</span> TIMESTAMPDIFF(<span class="keyword">MINUTE</span>, v_start_time, NOW());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 更新使用记录（触发器会自动更新预约和设备状态）</span></span><br><span class="line">    <span class="keyword">UPDATE</span> usage_records </span><br><span class="line">    <span class="keyword">SET</span> usage_end_time <span class="operator">=</span> NOW(), </span><br><span class="line">        usage_status <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span>,</span><br><span class="line">        remark <span class="operator">=</span> CONCAT(</span><br><span class="line">            IFNULL(p_usage_note, <span class="string">&#x27;&#x27;</span>), </span><br><span class="line">            <span class="string">&#x27; [使用时长: &#x27;</span>, v_duration_minutes, <span class="string">&#x27;分钟]&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> v_usage_id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(<span class="string">&#x27;使用完成，总时长: &#x27;</span>, v_duration_minutes, <span class="string">&#x27;分钟&#x27;</span>);</span><br><span class="line">    <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-2-1-4-取消预约存储过程">7.2.1.4 取消预约存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_cancel_reservation</code></p>
<p><strong>输入参数</strong>：</p>
<ul>
<li><code>p_reservation_id INT</code> - 预约记录ID</li>
<li><code>p_user_id INT</code> - 用户ID</li>
<li><code>p_reason VARCHAR(500)</code>- 取消原因</li>
</ul>
<p><strong>输出参数</strong>：</p>
<ul>
<li><code>p_result INT</code> - 操作结果码</li>
<li><code>p_message VARCHAR(200)</code> - 结果消息</li>
</ul>
<p><strong>功能</strong>：验证用户身份、检查预约状态、更新预约状态为<code>cancelled</code>，记录取消原因</p>
<p><strong>关键设计</strong>：</p>
<ul>
<li>利用身份验证来防止用户取消他人预约</li>
<li>只能取消特定状态的预约</li>
<li>行级锁：防止并发取消冲突</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_cancel_reservation(</span><br><span class="line">    <span class="keyword">IN</span> p_reservation_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_user_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_reason <span class="type">VARCHAR</span>(<span class="number">500</span>),</span><br><span class="line">    <span class="keyword">OUT</span> p_result <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">OUT</span> p_message <span class="type">VARCHAR</span>(<span class="number">200</span>)</span><br><span class="line">)</span><br><span class="line">proc_label: <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_user_id <span class="type">INT</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 统一异常处理</span></span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-99</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;系统错误，请稍后重试&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 参数验证</span></span><br><span class="line">    IF p_reservation_id <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> p_reservation_id <span class="operator">&lt;=</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;无效的预约ID&#x27;</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取预约信息（加锁）</span></span><br><span class="line">    <span class="keyword">SELECT</span> status, user_id <span class="keyword">INTO</span> v_status, v_user_id</span><br><span class="line">    <span class="keyword">FROM</span> reservation_records</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_reservation_id</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查预约是否存在</span></span><br><span class="line">    IF v_status <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-2</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;预约记录不存在&#x27;</span>;</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 验证用户身份（防止越权操作）</span></span><br><span class="line">    IF p_user_id <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">AND</span> p_user_id <span class="operator">!=</span> v_user_id <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-3</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;您不是该预约的申请人&#x27;</span>;</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查预约状态（只能取消待审批或已批准的预约）</span></span><br><span class="line">    IF v_status <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-4</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(<span class="string">&#x27;当前状态不允许取消: &#x27;</span>, v_status);</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 执行取消操作</span></span><br><span class="line">    <span class="keyword">UPDATE</span> reservation_records </span><br><span class="line">    <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;cancelled&#x27;</span>,</span><br><span class="line">        approval_note <span class="operator">=</span> CONCAT(<span class="string">&#x27;用户取消: &#x27;</span>, IFNULL(p_reason, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_reservation_id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;预约已取消&#x27;</span>;</span><br><span class="line">    <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-2-1-5-查询设备可用时间段存储过程">7.2.1.5 查询设备可用时间段存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_get_equipment_available_slots</code></p>
<p><strong>输入参数</strong>：</p>
<ul>
<li><code>p_equipment_id INT</code> - 设备ID</li>
<li><code>p_start_date DATE</code> - 查询开始日期</li>
<li><code>p_start_date DATE</code> - 查询结束日期</li>
</ul>
<p><strong>输出</strong>：</p>
<ul>
<li>设备基本状态信息</li>
<li>指定时间段内的预约记录列表</li>
</ul>
<p><strong>功能</strong>：查询设备当前状态和科预约性、列出指定时间段内的所有预约记录，帮助用户得到可用时间段</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_get_equipment_available_slots(</span><br><span class="line">    <span class="keyword">IN</span> p_equipment_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_start_date <span class="type">DATE</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_end_date <span class="type">DATE</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_equipment_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取设备状态</span></span><br><span class="line">    <span class="keyword">SELECT</span> status <span class="keyword">INTO</span> v_equipment_status </span><br><span class="line">    <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> p_equipment_id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 结果集1：返回设备基本信息</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        p_equipment_id <span class="keyword">AS</span> equipment_id, </span><br><span class="line">        v_equipment_status <span class="keyword">AS</span> equipment_status,</span><br><span class="line">        <span class="keyword">CASE</span> v_equipment_status </span><br><span class="line">            <span class="keyword">WHEN</span> <span class="string">&#x27;scrapped&#x27;</span> <span class="keyword">THEN</span> <span class="string">&#x27;设备已报废&#x27;</span></span><br><span class="line">            <span class="keyword">WHEN</span> <span class="string">&#x27;maintenance&#x27;</span> <span class="keyword">THEN</span> <span class="string">&#x27;设备维修中&#x27;</span></span><br><span class="line">            <span class="keyword">ELSE</span> <span class="string">&#x27;可预约&#x27;</span></span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">AS</span> availability_message;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 结果集2：返回已预约时间段</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        id <span class="keyword">AS</span> reservation_id,</span><br><span class="line">        expected_start_time,</span><br><span class="line">        expected_end_time,</span><br><span class="line">        status,</span><br><span class="line">        <span class="keyword">CASE</span> status</span><br><span class="line">            <span class="keyword">WHEN</span> <span class="string">&#x27;pending&#x27;</span> <span class="keyword">THEN</span> <span class="string">&#x27;待审批&#x27;</span></span><br><span class="line">            <span class="keyword">WHEN</span> <span class="string">&#x27;approved&#x27;</span> <span class="keyword">THEN</span> <span class="string">&#x27;已批准&#x27;</span></span><br><span class="line">            <span class="keyword">WHEN</span> <span class="string">&#x27;in_use&#x27;</span> <span class="keyword">THEN</span> <span class="string">&#x27;使用中&#x27;</span></span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">AS</span> status_text</span><br><span class="line">    <span class="keyword">FROM</span> reservation_records</span><br><span class="line">    <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> p_equipment_id</span><br><span class="line">      <span class="keyword">AND</span> expected_start_time <span class="operator">&gt;=</span> p_start_date</span><br><span class="line">      <span class="keyword">AND</span> expected_end_time <span class="operator">&lt;=</span> DATE_ADD(p_end_date, <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>)</span><br><span class="line">      <span class="keyword">AND</span> status <span class="keyword">IN</span> (<span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="string">&#x27;in_use&#x27;</span>)</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> expected_start_time;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h4 id="7-2-2-维修管理存储过程">7.2.2 维修管理存储过程</h4>
<h5 id="7-2-2-1-分派维修任务存储过程">7.2.2.1 分派维修任务存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_assign_maintenance_task</code></p>
<p><strong>输入参数</strong>：</p>
<ul>
<li><code>p_warranty_id INT</code> - 设备ID</li>
<li><code>p_dispatcher_id INT</code> - 分派任务的管理员ID</li>
<li><code>p_maintenance_user_id INT</code> - 维修人员ID</li>
<li><code>p_priority ENUM</code> - 维修任务的处理优先级</li>
<li><code>p_note TEXT</code> - 分配的备注</li>
</ul>
<p><strong>输出参数</strong>：</p>
<ul>
<li><code>p_result INT</code> - 操作结果码</li>
<li><code>p_message VARCHAR(200)</code> - 结果消息</li>
</ul>
<p><strong>功能概述</strong>：检查维修记录状态、验证维修人员存在性、分配任务并记录进度</p>
<p><strong>关键设计</strong>：自动统计维修人员未完成任务数，超过5个给出警告（但不阻止分派）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_assign_maintenance_task(</span><br><span class="line">    <span class="keyword">IN</span> p_warranty_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_dispatcher_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_maintenance_user_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_priority <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    <span class="keyword">IN</span> p_note <span class="type">VARCHAR</span>(<span class="number">500</span>),</span><br><span class="line">    <span class="keyword">OUT</span> p_result <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">OUT</span> p_message <span class="type">VARCHAR</span>(<span class="number">200</span>)</span><br><span class="line">)</span><br><span class="line">proc_label: <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_maint_exists <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_maint_username <span class="type">VARCHAR</span>(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_current_workload <span class="type">INT</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-99</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;系统错误，请稍后重试&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查维修记录状态</span></span><br><span class="line">    <span class="keyword">SELECT</span> status <span class="keyword">INTO</span> v_status</span><br><span class="line">    <span class="keyword">FROM</span> warranty_records</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_warranty_id</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查维修人员</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>), <span class="built_in">MAX</span>(username) </span><br><span class="line">    <span class="keyword">INTO</span> v_maint_exists, v_maint_username</span><br><span class="line">    <span class="keyword">FROM</span> maintenance_users</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_maintenance_user_id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取维修人员当前工作负荷</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">INTO</span> v_current_workload</span><br><span class="line">    <span class="keyword">FROM</span> warranty_records</span><br><span class="line">    <span class="keyword">WHERE</span> maintenance_user_id <span class="operator">=</span> p_maintenance_user_id</span><br><span class="line">      <span class="keyword">AND</span> status <span class="keyword">IN</span> (<span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    IF v_status <span class="operator">!=</span> <span class="string">&#x27;pending&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-3</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(<span class="string">&#x27;维修状态不允许分派: &#x27;</span>, v_status);</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 工作负荷警告（但不阻止分派）</span></span><br><span class="line">    IF v_current_workload <span class="operator">&gt;=</span> <span class="number">5</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(</span><br><span class="line">            <span class="string">&#x27;警告: &#x27;</span>, v_maint_username, </span><br><span class="line">            <span class="string">&#x27; 当前有&#x27;</span>, v_current_workload, <span class="string">&#x27;个未完成任务&#x27;</span></span><br><span class="line">        );</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 分派任务</span></span><br><span class="line">    <span class="keyword">UPDATE</span> warranty_records</span><br><span class="line">    <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;assigned&#x27;</span>,</span><br><span class="line">        dispatcher_id <span class="operator">=</span> p_dispatcher_id,</span><br><span class="line">        maintenance_user_id <span class="operator">=</span> p_maintenance_user_id,</span><br><span class="line">        assigned_at <span class="operator">=</span> NOW(),</span><br><span class="line">        priority <span class="operator">=</span> IFNULL(p_priority, priority),</span><br><span class="line">        dispatcher_note <span class="operator">=</span> p_note</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_warranty_id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 记录进度</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> warranty_progress (</span><br><span class="line">        warranty_id, actor_role, actor_id, status, note</span><br><span class="line">    ) <span class="keyword">VALUES</span> (</span><br><span class="line">        p_warranty_id, <span class="string">&#x27;admin&#x27;</span>, p_dispatcher_id, <span class="string">&#x27;assigned&#x27;</span>, </span><br><span class="line">        CONCAT(<span class="string">&#x27;分派给: &#x27;</span>, v_maint_username, <span class="string">&#x27;. &#x27;</span>, IFNULL(p_note, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    IF p_message <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> p_message <span class="operator">=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(<span class="string">&#x27;任务已分派给 &#x27;</span>, v_maint_username);</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-2-2-2-开始维修任务存储过程">7.2.2.2 开始维修任务存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_start_maintenance</code></p>
<p><strong>输入参数</strong>：</p>
<ul>
<li><code>p_warranty_id INT</code> - 维修记录ID</li>
<li><code>p_maintenance_user_id INT</code> - 维修人员ID</li>
<li><code>p_note VARCHAR(500)</code> - 开始维修备注</li>
</ul>
<p>输出参数</p>
<ul>
<li><code>p_result INT</code> - 操作结果码</li>
<li><code>p_message VARCHAR(200)</code> - 结果消息</li>
</ul>
<p><strong>功能</strong>：验证维修人员权限、检查维修状态、记录维修开始时间、更新维修状态为 <code>in_progress</code>、自动记录维修进度</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_complete_maintenance(</span><br><span class="line">    <span class="keyword">IN</span> p_warranty_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_maintenance_user_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_solution <span class="type">VARCHAR</span>(<span class="number">1000</span>),</span><br><span class="line">    <span class="keyword">IN</span> p_parts_used <span class="type">VARCHAR</span>(<span class="number">500</span>),</span><br><span class="line">    <span class="keyword">OUT</span> p_result <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">OUT</span> p_message <span class="type">VARCHAR</span>(<span class="number">200</span>)</span><br><span class="line">)</span><br><span class="line">proc_label: <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_assigned_user <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_started_at DATETIME;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_duration_hours <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-99</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;系统错误，请稍后重试&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 必填参数校验</span></span><br><span class="line">    IF p_solution <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> p_solution <span class="operator">=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;请填写维修方案/结果&#x27;</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SELECT</span> status, maintenance_user_id, started_at </span><br><span class="line">    <span class="keyword">INTO</span> v_status, v_assigned_user, v_started_at</span><br><span class="line">    <span class="keyword">FROM</span> warranty_records</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_warranty_id</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 权限检查</span></span><br><span class="line">    IF v_assigned_user <span class="operator">!=</span> p_maintenance_user_id <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-4</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;您不是该任务的负责人&#x27;</span>;</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 计算维修时长（小时，保留1位小数）</span></span><br><span class="line">    IF v_started_at <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> v_duration_hours <span class="operator">=</span> </span><br><span class="line">            TIMESTAMPDIFF(<span class="keyword">MINUTE</span>, v_started_at, NOW()) <span class="operator">/</span> <span class="number">60.0</span>;</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">        <span class="keyword">SET</span> v_duration_hours <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 完成维修（触发器会自动恢复设备状态）</span></span><br><span class="line">    <span class="keyword">UPDATE</span> warranty_records</span><br><span class="line">    <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span>,</span><br><span class="line">        completed_at <span class="operator">=</span> NOW(),</span><br><span class="line">        maintenance_note <span class="operator">=</span> CONCAT(</span><br><span class="line">            <span class="string">&#x27;维修方案: &#x27;</span>, p_solution, </span><br><span class="line">            IF(p_parts_used <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">AND</span> p_parts_used <span class="operator">!=</span> <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">               CONCAT(<span class="string">&#x27; | 使用配件: &#x27;</span>, p_parts_used), <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27; | 维修耗时: &#x27;</span>, ROUND(v_duration_hours, <span class="number">1</span>), <span class="string">&#x27;小时&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_warranty_id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 记录进度</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> warranty_progress (</span><br><span class="line">        warranty_id, actor_role, actor_id, status, note</span><br><span class="line">    ) <span class="keyword">VALUES</span> (</span><br><span class="line">        p_warranty_id, <span class="string">&#x27;maintenance&#x27;</span>, p_maintenance_user_id, <span class="string">&#x27;completed&#x27;</span>, </span><br><span class="line">        CONCAT(<span class="string">&#x27;维修完成. 方案: &#x27;</span>, <span class="keyword">LEFT</span>(p_solution, <span class="number">200</span>))</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(</span><br><span class="line">        <span class="string">&#x27;维修完成，耗时: &#x27;</span>, ROUND(v_duration_hours, <span class="number">1</span>), <span class="string">&#x27;小时&#x27;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-2-2-3-完成维修任务存储过程">7.2.2.3 完成维修任务存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_complete_maintenance</code></p>
<p><strong>输入参数</strong>：</p>
<ul>
<li><code>p_warranty_id INT</code> - 设备ID</li>
<li><code>p_maintenance_user_id INT</code> - 维修人员ID</li>
<li><code>p_parts_used INT</code> - 使用的零件ID</li>
<li><code>p_solution TEXT</code> - 维修说明</li>
</ul>
<p><strong>输出参数</strong>：</p>
<ul>
<li><code>p_result INT</code> - 操作结果码</li>
<li><code>p_message VARCHAR(200)</code> - 结果消息</li>
</ul>
<p><strong>功能概述</strong>：验证维修人员权限、自动计算维修耗时、更新维修记录并记录进度</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_complete_maintenance(</span><br><span class="line">    <span class="keyword">IN</span> p_warranty_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_maintenance_user_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_solution <span class="type">VARCHAR</span>(<span class="number">1000</span>),</span><br><span class="line">    <span class="keyword">IN</span> p_parts_used <span class="type">VARCHAR</span>(<span class="number">500</span>),</span><br><span class="line">    <span class="keyword">OUT</span> p_result <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">OUT</span> p_message <span class="type">VARCHAR</span>(<span class="number">200</span>)</span><br><span class="line">)</span><br><span class="line">proc_label: <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_status <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_assigned_user <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_started_at DATETIME;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_duration_hours <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 统一异常处理</span></span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-99</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;系统错误，请稍后重试&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 参数验证：维修记录ID</span></span><br><span class="line">    IF p_warranty_id <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> p_warranty_id <span class="operator">&lt;=</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;无效的维修记录ID&#x27;</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 参数验证：维修方案必填（关键业务规则）</span></span><br><span class="line">    IF p_solution <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> p_solution <span class="operator">=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;请填写维修方案/结果&#x27;</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取维修记录信息（加锁）</span></span><br><span class="line">    <span class="keyword">SELECT</span> status, maintenance_user_id, started_at </span><br><span class="line">    <span class="keyword">INTO</span> v_status, v_assigned_user, v_started_at</span><br><span class="line">    <span class="keyword">FROM</span> warranty_records</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_warranty_id</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查维修记录是否存在</span></span><br><span class="line">    IF v_status <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-2</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;维修记录不存在&#x27;</span>;</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查维修状态（可以从assigned或in_progress完成）</span></span><br><span class="line">    IF v_status <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-3</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(<span class="string">&#x27;维修状态不允许完成: &#x27;</span>, v_status);</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 验证维修人员权限（防止越权操作）</span></span><br><span class="line">    IF v_assigned_user <span class="operator">!=</span> p_maintenance_user_id <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-4</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;您不是该任务的负责人&#x27;</span>;</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 自动计算维修时长（关键功能）</span></span><br><span class="line">    IF v_started_at <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="comment">-- 计算分钟数，然后转换为小时，保留2位小数</span></span><br><span class="line">        <span class="keyword">SET</span> v_duration_hours <span class="operator">=</span> </span><br><span class="line">            TIMESTAMPDIFF(<span class="keyword">MINUTE</span>, v_started_at, NOW()) <span class="operator">/</span> <span class="number">60.0</span>;</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">        <span class="comment">-- 如果没有开始时间（直接从assigned跳到completed），耗时为0</span></span><br><span class="line">        <span class="keyword">SET</span> v_duration_hours <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 完成维修（触发器会自动恢复设备状态）</span></span><br><span class="line">    <span class="keyword">UPDATE</span> warranty_records</span><br><span class="line">    <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span>,</span><br><span class="line">        completed_at <span class="operator">=</span> NOW(),</span><br><span class="line">        <span class="comment">-- 自动生成详细的维修笔记</span></span><br><span class="line">        maintenance_note <span class="operator">=</span> CONCAT(</span><br><span class="line">            <span class="string">&#x27;维修方案: &#x27;</span>, p_solution, </span><br><span class="line">            <span class="comment">-- 如果提供了配件信息，则追加</span></span><br><span class="line">            IF(p_parts_used <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">AND</span> p_parts_used <span class="operator">!=</span> <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">               CONCAT(<span class="string">&#x27; | 使用配件: &#x27;</span>, p_parts_used), <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="comment">-- 自动追加耗时信息</span></span><br><span class="line">            <span class="string">&#x27; | 维修耗时: &#x27;</span>, ROUND(v_duration_hours, <span class="number">1</span>), <span class="string">&#x27;小时&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_warranty_id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 记录维修进度（审计追踪）</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> warranty_progress (</span><br><span class="line">        warranty_id, actor_role, actor_id, status, note</span><br><span class="line">    ) <span class="keyword">VALUES</span> (</span><br><span class="line">        p_warranty_id, </span><br><span class="line">        <span class="string">&#x27;maintenance&#x27;</span>, </span><br><span class="line">        p_maintenance_user_id, </span><br><span class="line">        <span class="string">&#x27;completed&#x27;</span>, </span><br><span class="line">        <span class="comment">-- 只记录前200字符，防止过长</span></span><br><span class="line">        CONCAT(<span class="string">&#x27;维修完成. 方案: &#x27;</span>, <span class="keyword">LEFT</span>(p_solution, <span class="number">200</span>))</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">-- 返回消息包含耗时信息</span></span><br><span class="line">    <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(</span><br><span class="line">        <span class="string">&#x27;维修完成，耗时: &#x27;</span>, ROUND(v_duration_hours, <span class="number">1</span>), <span class="string">&#x27;小时&#x27;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-2-2-4-获取维修人员工作负荷存储过程">7.2.2.4 获取维修人员工作负荷存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_get_maintenance_workload</code></p>
<p><strong>输入参数</strong>：无</p>
<p><strong>输出参数</strong>：</p>
<ul>
<li><code>maintenance_user_id</code> - 维修人员ID</li>
<li><code>username</code> - 用户名</li>
<li><code>expertise</code> - 擅长领域</li>
<li><code>pending_tasks</code> - 待处理任务数</li>
<li><code>in_progress_tasks</code> - 处理中任务数</li>
<li><code>urgent_tasks</code> - 紧急任务数</li>
<li><code>completed_this_month</code> - 本月完成数</li>
<li><code>avg_completion_hours</code> - 平均完成时长</li>
<li><code>recommendation</code> - 推荐指数</li>
</ul>
<p><strong>功能</strong>：统计所有维修人员的工作负荷，提供分派建议</p>
<p><strong>使用场景</strong>：管理员分派维修任务前，查询各维修人员工作负荷，选择最合适的人员</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_get_maintenance_workload()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        m.id <span class="keyword">AS</span> maintenance_user_id,</span><br><span class="line">        m.username,</span><br><span class="line">        m.expertise,</span><br><span class="line">        m.phone,</span><br><span class="line">        <span class="built_in">COUNT</span>(w.id) <span class="keyword">AS</span> total_assigned,</span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> w.status <span class="operator">=</span> <span class="string">&#x27;assigned&#x27;</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) </span><br><span class="line">            <span class="keyword">AS</span> pending_tasks,</span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> w.status <span class="operator">=</span> <span class="string">&#x27;in_progress&#x27;</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) </span><br><span class="line">            <span class="keyword">AS</span> in_progress_tasks,</span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> w.priority <span class="operator">=</span> <span class="string">&#x27;urgent&#x27;</span> </span><br><span class="line">                      <span class="keyword">AND</span> w.status <span class="keyword">IN</span> (<span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>) </span><br><span class="line">             <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="keyword">AS</span> urgent_tasks,</span><br><span class="line">        <span class="comment">-- 本月完成数</span></span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> w.status <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span> </span><br><span class="line">                      <span class="keyword">AND</span> <span class="keyword">MONTH</span>(w.completed_at) <span class="operator">=</span> <span class="keyword">MONTH</span>(NOW()) </span><br><span class="line">             <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="keyword">AS</span> completed_this_month,</span><br><span class="line">        <span class="comment">-- 平均完成时间（小时）</span></span><br><span class="line">        ROUND(<span class="built_in">AVG</span>(</span><br><span class="line">            <span class="keyword">CASE</span> <span class="keyword">WHEN</span> w.status <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span> </span><br><span class="line">                      <span class="keyword">AND</span> w.started_at <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> </span><br><span class="line">             <span class="keyword">THEN</span> TIMESTAMPDIFF(<span class="keyword">MINUTE</span>, w.started_at, w.completed_at) <span class="operator">/</span> <span class="number">60.0</span> </span><br><span class="line">             <span class="keyword">ELSE</span> <span class="keyword">NULL</span> <span class="keyword">END</span></span><br><span class="line">        ), <span class="number">1</span>) <span class="keyword">AS</span> avg_completion_hours,</span><br><span class="line">        <span class="comment">-- 推荐指数</span></span><br><span class="line">        <span class="keyword">CASE</span> </span><br><span class="line">            <span class="keyword">WHEN</span> <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> w.status <span class="keyword">IN</span> (<span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>) </span><br><span class="line">                          <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line">                <span class="keyword">THEN</span> <span class="string">&#x27;强烈推荐&#x27;</span></span><br><span class="line">            <span class="keyword">WHEN</span> <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> w.status <span class="keyword">IN</span> (<span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>) </span><br><span class="line">                          <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="operator">&lt;=</span> <span class="number">2</span> </span><br><span class="line">                <span class="keyword">THEN</span> <span class="string">&#x27;推荐&#x27;</span></span><br><span class="line">            <span class="keyword">WHEN</span> <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> w.status <span class="keyword">IN</span> (<span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>) </span><br><span class="line">                          <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="operator">&lt;=</span> <span class="number">5</span> </span><br><span class="line">                <span class="keyword">THEN</span> <span class="string">&#x27;一般&#x27;</span></span><br><span class="line">            <span class="keyword">ELSE</span> <span class="string">&#x27;繁忙&#x27;</span></span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">AS</span> recommendation</span><br><span class="line">    <span class="keyword">FROM</span> maintenance_users m</span><br><span class="line">    <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> warranty_records w <span class="keyword">ON</span> m.id <span class="operator">=</span> w.maintenance_user_id</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> m.id, m.username, m.expertise, m.phone</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> pending_tasks <span class="keyword">ASC</span>, in_progress_tasks <span class="keyword">ASC</span>;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h4 id="7-2-3-采购管理存储过程">7.2.3 采购管理存储过程</h4>
<h5 id="7-2-3-1-创建采购工单存储过程">7.2.3.1 创建采购工单存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_create_purchase_order</code></p>
<p><strong>输入参数</strong>：</p>
<ul>
<li><code>p_maintenance_request_id INT</code> - 关联的维修请求ID（可选）</li>
<li><code>p_equipment_id INT</code> - 关联的设备ID（可选）</li>
<li><code>p_part_id INT</code> - 零件ID（必填）</li>
<li><code>p_part_manufacturer_id INT</code> - 零件-厂商关联ID（必填）</li>
<li><code>p_quantity INT</code> - 采购数量（必填）</li>
<li><code>p_requester_id INT</code> - 申请人ID（必填）</li>
<li><code>p_request_reason VARCHAR(500)</code> - 申请原因（可选）</li>
<li><code>p_urgency VARCHAR(20)</code> - 紧急程度（可选，默认’normal’）</li>
<li><code>p_expected_delivery_date DATE</code> - 期望交付日期（可选）</li>
</ul>
<p><strong>输出参数</strong>：</p>
<ul>
<li><code>p_result INT</code> - 操作结果码</li>
<li><code>p_message VARCHAR(200)</code> - 结果消息</li>
<li><code>p_order_id INT</code> - 返回新创建的工单ID</li>
</ul>
<p><strong>功能</strong>：校验零件存在性和状态、获取零件-厂商价格信息、自动生成唯一工单编号、返回详细的创建结构消息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_create_purchase_order(</span><br><span class="line">    <span class="keyword">IN</span> p_maintenance_request_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_equipment_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_part_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_part_manufacturer_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_quantity <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_requester_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_request_reason <span class="type">VARCHAR</span>(<span class="number">500</span>),</span><br><span class="line">    <span class="keyword">IN</span> p_urgency <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    <span class="keyword">IN</span> p_expected_delivery_date <span class="type">DATE</span>,</span><br><span class="line">    <span class="keyword">OUT</span> p_result <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">OUT</span> p_message <span class="type">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">    <span class="keyword">OUT</span> p_order_id <span class="type">INT</span></span><br><span class="line">)</span><br><span class="line">proc_label: <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_part_exists <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_part_name <span class="type">VARCHAR</span>(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_pm_price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_manufacturer_name <span class="type">VARCHAR</span>(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_order_number <span class="type">VARCHAR</span>(<span class="number">50</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-99</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;系统错误，请稍后重试&#x27;</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_order_id <span class="operator">=</span> <span class="keyword">NULL</span>;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 数量校验</span></span><br><span class="line">    IF p_quantity <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> p_quantity <span class="operator">&lt;=</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;采购数量必须大于0&#x27;</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_order_id <span class="operator">=</span> <span class="keyword">NULL</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查零件</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>), <span class="built_in">MAX</span>(part_name) </span><br><span class="line">    <span class="keyword">INTO</span> v_part_exists, v_part_name</span><br><span class="line">    <span class="keyword">FROM</span> parts </span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> p_part_id <span class="keyword">AND</span> status <span class="operator">=</span> <span class="string">&#x27;active&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取价格和厂商（联表查询）</span></span><br><span class="line">    <span class="keyword">SELECT</span> pm.price, m.manufacturer_name </span><br><span class="line">    <span class="keyword">INTO</span> v_pm_price, v_manufacturer_name</span><br><span class="line">    <span class="keyword">FROM</span> part_manufacturers pm</span><br><span class="line">    <span class="keyword">JOIN</span> manufacturers m <span class="keyword">ON</span> pm.manufacturer_id <span class="operator">=</span> m.id</span><br><span class="line">    <span class="keyword">WHERE</span> pm.id <span class="operator">=</span> p_part_manufacturer_id </span><br><span class="line">      <span class="keyword">AND</span> pm.part_id <span class="operator">=</span> p_part_id;</span><br><span class="line">    </span><br><span class="line">    IF v_pm_price <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">-3</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_message <span class="operator">=</span> <span class="string">&#x27;零件-厂商关联不存在&#x27;</span>;</span><br><span class="line">        <span class="keyword">SET</span> p_order_id <span class="operator">=</span> <span class="keyword">NULL</span>;</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        LEAVE proc_label;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 生成唯一工单编号</span></span><br><span class="line">    <span class="keyword">SET</span> v_order_number <span class="operator">=</span> CONCAT(</span><br><span class="line">        <span class="string">&#x27;PO&#x27;</span>, </span><br><span class="line">        DATE_FORMAT(NOW(), <span class="string">&#x27;%Y%m%d%H%i%s&#x27;</span>), </span><br><span class="line">        LPAD(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">10000</span>), <span class="number">4</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 创建工单</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> purchase_orders (</span><br><span class="line">        order_number, maintenance_request_id, equipment_id, part_id,</span><br><span class="line">        part_manufacturer_id, quantity, unit_price, requester_id,</span><br><span class="line">        request_reason, urgency, expected_delivery_date, status</span><br><span class="line">    ) <span class="keyword">VALUES</span> (</span><br><span class="line">        v_order_number, p_maintenance_request_id, p_equipment_id, </span><br><span class="line">        p_part_id, p_part_manufacturer_id, p_quantity, v_pm_price, </span><br><span class="line">        p_requester_id, p_request_reason, </span><br><span class="line">        IFNULL(p_urgency, <span class="string">&#x27;normal&#x27;</span>), p_expected_delivery_date, <span class="string">&#x27;pending&#x27;</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> p_order_id <span class="operator">=</span> LAST_INSERT_ID();</span><br><span class="line">    <span class="keyword">SET</span> p_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">SET</span> p_message <span class="operator">=</span> CONCAT(</span><br><span class="line">        <span class="string">&#x27;采购工单创建成功 [&#x27;</span>, v_order_number, <span class="string">&#x27;] &#x27;</span>, </span><br><span class="line">        v_part_name, <span class="string">&#x27; x&#x27;</span>, p_quantity, </span><br><span class="line">        <span class="string">&#x27; 厂商:&#x27;</span>, v_manufacturer_name,</span><br><span class="line">        <span class="string">&#x27; 金额:￥&#x27;</span>, FORMAT(v_pm_price <span class="operator">*</span> p_quantity, <span class="number">2</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-2-3-2-审批采购工单存储过程">7.2.3.2 审批采购工单存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_approve_purchase_order</code></p>
<p><strong>输入参数</strong>：</p>
<ul>
<li><code>p_order_id INT</code> - 工单ID</li>
<li><code>p_approver_id INT</code> - 审批人ID</li>
<li><code>p_approved BOOLEAN</code> - 是否批准（TRUE=批准，FALSE=拒绝）</li>
<li><code>p_note VARCHAR(500)</code> - 审批意见</li>
</ul>
<p><strong>输出参数</strong>：</p>
<ul>
<li><code>p_result INT</code> - 操作结果码</li>
<li><code>p_message VARCHAR(200)</code> - 结果消息</li>
</ul>
<p><strong>核心功能</strong>：检查工单状态、更新工单状态、记录审批人和审批时间、<strong>触发器会自动记录进度</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_get_purchase_statistics(</span><br><span class="line">    <span class="keyword">IN</span> p_start_date <span class="type">DATE</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_end_date <span class="type">DATE</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 1. 汇总统计</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> total_orders,</span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> status <span class="operator">=</span> <span class="string">&#x27;pending&#x27;</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) </span><br><span class="line">            <span class="keyword">AS</span> pending_count,</span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) </span><br><span class="line">            <span class="keyword">AS</span> approved_count,</span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> status <span class="operator">=</span> <span class="string">&#x27;rejected&#x27;</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) </span><br><span class="line">            <span class="keyword">AS</span> rejected_count,</span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span> </span><br><span class="line">             <span class="keyword">THEN</span> unit_price <span class="operator">*</span> quantity <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="keyword">AS</span> approved_amount,</span><br><span class="line">        ROUND(<span class="built_in">AVG</span>(</span><br><span class="line">            <span class="keyword">CASE</span> <span class="keyword">WHEN</span> status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span> <span class="keyword">AND</span> approval_time <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> </span><br><span class="line">            <span class="keyword">THEN</span> TIMESTAMPDIFF(<span class="keyword">HOUR</span>, created_at, approval_time) </span><br><span class="line">            <span class="keyword">ELSE</span> <span class="keyword">NULL</span> <span class="keyword">END</span></span><br><span class="line">        ), <span class="number">1</span>) <span class="keyword">AS</span> avg_approval_hours</span><br><span class="line">    <span class="keyword">FROM</span> purchase_orders</span><br><span class="line">    <span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> IFNULL(p_start_date, <span class="string">&#x27;2000-01-01&#x27;</span>)</span><br><span class="line">      <span class="keyword">AND</span> created_at <span class="operator">&lt;=</span> IFNULL(p_end_date, NOW());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 2. 按零件分类统计</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        p.category,</span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> order_count,</span><br><span class="line">        <span class="built_in">SUM</span>(po.quantity) <span class="keyword">AS</span> total_quantity,</span><br><span class="line">        <span class="built_in">SUM</span>(po.unit_price <span class="operator">*</span> po.quantity) <span class="keyword">AS</span> total_amount</span><br><span class="line">    <span class="keyword">FROM</span> purchase_orders po</span><br><span class="line">    <span class="keyword">JOIN</span> parts p <span class="keyword">ON</span> po.part_id <span class="operator">=</span> p.id</span><br><span class="line">    <span class="keyword">WHERE</span> po.status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span></span><br><span class="line">      <span class="keyword">AND</span> po.created_at <span class="operator">&gt;=</span> IFNULL(p_start_date, <span class="string">&#x27;2000-01-01&#x27;</span>)</span><br><span class="line">      <span class="keyword">AND</span> po.created_at <span class="operator">&lt;=</span> IFNULL(p_end_date, NOW())</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> p.category</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> total_amount <span class="keyword">DESC</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 3. 按厂商统计</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        m.manufacturer_name,</span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> order_count,</span><br><span class="line">        <span class="built_in">SUM</span>(po.quantity) <span class="keyword">AS</span> total_quantity,</span><br><span class="line">        <span class="built_in">SUM</span>(po.unit_price <span class="operator">*</span> po.quantity) <span class="keyword">AS</span> total_amount</span><br><span class="line">    <span class="keyword">FROM</span> purchase_orders po</span><br><span class="line">    <span class="keyword">JOIN</span> part_manufacturers pm <span class="keyword">ON</span> po.part_manufacturer_id <span class="operator">=</span> pm.id</span><br><span class="line">    <span class="keyword">JOIN</span> manufacturers m <span class="keyword">ON</span> pm.manufacturer_id <span class="operator">=</span> m.id</span><br><span class="line">    <span class="keyword">WHERE</span> po.status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span></span><br><span class="line">      <span class="keyword">AND</span> po.created_at <span class="operator">&gt;=</span> IFNULL(p_start_date, <span class="string">&#x27;2000-01-01&#x27;</span>)</span><br><span class="line">      <span class="keyword">AND</span> po.created_at <span class="operator">&lt;=</span> IFNULL(p_end_date, NOW())</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> m.id, m.manufacturer_name</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> total_amount <span class="keyword">DESC</span>;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h5 id="7-2-3-3-获取采购统计报表存储过程">7.2.3.3 获取采购统计报表存储过程</h5>
<p><strong>存储过程名称</strong>：<code>sp_get_purchase_statistics</code></p>
<p><strong>输入参数列表</strong>：</p>
<ul>
<li><code>p_start_date DATE</code> - 统计开始日期</li>
<li><code>p_end_date DATE</code> - 统计结束日期</li>
</ul>
<p><strong>返回结果</strong>：</p>
<ol>
<li><strong>汇总统计</strong>：总工单数、各状态数量、总金额、平均审批时长</li>
<li><strong>按零件分类统计</strong>：各分类的工单数、数量、金额</li>
<li><strong>按厂商统计</strong>：各厂商的工单数、数量、金额</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_get_purchase_statistics(</span><br><span class="line">    <span class="keyword">IN</span> p_start_date <span class="type">DATE</span>,</span><br><span class="line">    <span class="keyword">IN</span> p_end_date <span class="type">DATE</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 结果集1：汇总统计</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> total_orders,                                    <span class="comment">-- 总工单数</span></span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> status <span class="operator">=</span> <span class="string">&#x27;pending&#x27;</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) </span><br><span class="line">            <span class="keyword">AS</span> pending_count,                                        <span class="comment">-- 待审批数</span></span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) </span><br><span class="line">            <span class="keyword">AS</span> approved_count,                                       <span class="comment">-- 已批准数</span></span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> status <span class="operator">=</span> <span class="string">&#x27;rejected&#x27;</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) </span><br><span class="line">            <span class="keyword">AS</span> rejected_count,                                       <span class="comment">-- 已拒绝数</span></span><br><span class="line">        <span class="built_in">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span> </span><br><span class="line">             <span class="keyword">THEN</span> unit_price <span class="operator">*</span> quantity <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) </span><br><span class="line">            <span class="keyword">AS</span> approved_amount,                                      <span class="comment">-- 已批准总金额</span></span><br><span class="line">        ROUND(<span class="built_in">AVG</span>(</span><br><span class="line">            <span class="keyword">CASE</span> <span class="keyword">WHEN</span> status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span> <span class="keyword">AND</span> approval_time <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> </span><br><span class="line">            <span class="keyword">THEN</span> TIMESTAMPDIFF(<span class="keyword">HOUR</span>, created_at, approval_time)    <span class="comment">-- 审批时长（小时）</span></span><br><span class="line">            <span class="keyword">ELSE</span> <span class="keyword">NULL</span> <span class="keyword">END</span></span><br><span class="line">        ), <span class="number">1</span>) <span class="keyword">AS</span> avg_approval_hours                                  <span class="comment">-- 平均审批时长</span></span><br><span class="line">    <span class="keyword">FROM</span> purchase_orders</span><br><span class="line">    <span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> IFNULL(p_start_date, <span class="string">&#x27;2000-01-01&#x27;</span>)</span><br><span class="line">      <span class="keyword">AND</span> created_at <span class="operator">&lt;=</span> IFNULL(p_end_date, NOW());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 结果集2：按零件分类统计</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        p.category,                                                  <span class="comment">-- 零件分类</span></span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> order_count,                                     <span class="comment">-- 工单数</span></span><br><span class="line">        <span class="built_in">SUM</span>(po.quantity) <span class="keyword">AS</span> total_quantity,                          <span class="comment">-- 总数量</span></span><br><span class="line">        <span class="built_in">SUM</span>(po.unit_price <span class="operator">*</span> po.quantity) <span class="keyword">AS</span> total_amount            <span class="comment">-- 总金额</span></span><br><span class="line">    <span class="keyword">FROM</span> purchase_orders po</span><br><span class="line">    <span class="keyword">JOIN</span> parts p <span class="keyword">ON</span> po.part_id <span class="operator">=</span> p.id</span><br><span class="line">    <span class="keyword">WHERE</span> po.status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span>                                     <span class="comment">-- 只统计已批准的</span></span><br><span class="line">      <span class="keyword">AND</span> po.created_at <span class="operator">&gt;=</span> IFNULL(p_start_date, <span class="string">&#x27;2000-01-01&#x27;</span>)</span><br><span class="line">      <span class="keyword">AND</span> po.created_at <span class="operator">&lt;=</span> IFNULL(p_end_date, NOW())</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> p.category</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> total_amount <span class="keyword">DESC</span>;                                      <span class="comment">-- 按金额降序</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 结果集3：按厂商统计</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        m.manufacturer_name,                                         <span class="comment">-- 厂商名称</span></span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> order_count,                                     <span class="comment">-- 工单数</span></span><br><span class="line">        <span class="built_in">SUM</span>(po.quantity) <span class="keyword">AS</span> total_quantity,                          <span class="comment">-- 总数量</span></span><br><span class="line">        <span class="built_in">SUM</span>(po.unit_price <span class="operator">*</span> po.quantity) <span class="keyword">AS</span> total_amount            <span class="comment">-- 总金额</span></span><br><span class="line">    <span class="keyword">FROM</span> purchase_orders po</span><br><span class="line">    <span class="keyword">JOIN</span> part_manufacturers pm <span class="keyword">ON</span> po.part_manufacturer_id <span class="operator">=</span> pm.id</span><br><span class="line">    <span class="keyword">JOIN</span> manufacturers m <span class="keyword">ON</span> pm.manufacturer_id <span class="operator">=</span> m.id</span><br><span class="line">    <span class="keyword">WHERE</span> po.status <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span></span><br><span class="line">      <span class="keyword">AND</span> po.created_at <span class="operator">&gt;=</span> IFNULL(p_start_date, <span class="string">&#x27;2000-01-01&#x27;</span>)</span><br><span class="line">      <span class="keyword">AND</span> po.created_at <span class="operator">&lt;=</span> IFNULL(p_end_date, NOW())</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> m.id, m.manufacturer_name</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> total_amount <span class="keyword">DESC</span>;                                      <span class="comment">-- 按金额降序</span></span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="八、系统各项功能数据库端操作主要代码与结果说明">八、系统各项功能数据库端操作主要代码与结果说明</h2>
<h3 id="8-1-预约管理">8.1 预约管理</h3>
<h4 id="8-1-1-用户预约设备流程">8.1.1 用户预约设备流程</h4>
<p><strong>涉及的数据库对象</strong>：</p>
<ul>
<li>存储过程：<code>sp_approve_reservation</code>, <code>sp_start_using_equipment</code>, <code>sp_complete_using_equipment</code></li>
<li>触发器：<code>trg_reservation_status_change</code>, <code>trg_usage_status_change</code></li>
<li>表：<code>reservation_records</code>, <code>equipment</code>, <code>usage_records</code></li>
</ul>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ========== 步骤1：用户提交预约申请 ==========</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> reservation_records (</span><br><span class="line">    equipment_id, </span><br><span class="line">    user_id, </span><br><span class="line">    expected_start_time, </span><br><span class="line">    expected_end_time, </span><br><span class="line">    purpose, </span><br><span class="line">    status</span><br><span class="line">) <span class="keyword">VALUES</span> (</span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- 设备ID</span></span><br><span class="line">    <span class="number">5</span>,                              <span class="comment">-- 用户ID</span></span><br><span class="line">    <span class="string">&#x27;2025-12-22 09:00:00&#x27;</span>,         <span class="comment">-- 开始时间</span></span><br><span class="line">    <span class="string">&#x27;2025-12-22 11:00:00&#x27;</span>,         <span class="comment">-- 结束时间</span></span><br><span class="line">    <span class="string">&#x27;数据分析实验&#x27;</span>,                 <span class="comment">-- 用途</span></span><br><span class="line">    <span class="string">&#x27;pending&#x27;</span>                       <span class="comment">-- 初始状态：待审批</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 新增一条预约记录，状态为pending，等待管理员审批</span></span><br><span class="line"><span class="comment">-- 设备状态不变（仍为available）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证结果</span></span><br><span class="line"><span class="keyword">SELECT</span> id, status <span class="keyword">FROM</span> reservation_records <span class="keyword">WHERE</span> id <span class="operator">=</span> LAST_INSERT_ID();</span><br><span class="line"><span class="comment">-- 输出：id=1, status=&#x27;pending&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========== 步骤2：管理员审批预约 ==========</span></span><br><span class="line"><span class="keyword">CALL</span> sp_approve_reservation(</span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- reservation_id</span></span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- approver_id（管理员ID）</span></span><br><span class="line">    <span class="literal">TRUE</span>,                           <span class="comment">-- approved（批准）</span></span><br><span class="line">    <span class="string">&#x27;同意预约&#x27;</span>,                      <span class="comment">-- note</span></span><br><span class="line">    <span class="variable">@result</span>, </span><br><span class="line">    <span class="variable">@message</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@result</span> <span class="keyword">AS</span> 结果码, <span class="variable">@message</span> <span class="keyword">AS</span> 消息;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- @result = 1（成功）</span></span><br><span class="line"><span class="comment">-- @message = &#x27;预约审批通过&#x27;</span></span><br><span class="line"><span class="comment">-- 预约状态更新为 &#x27;approved&#x27;</span></span><br><span class="line"><span class="comment">-- 时间冲突检测通过</span></span><br><span class="line"><span class="comment">-- 记录审批人和审批时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证结果</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    id, </span><br><span class="line">    status, </span><br><span class="line">    approver_admin_id, </span><br><span class="line">    approval_time </span><br><span class="line"><span class="keyword">FROM</span> reservation_records </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- id=1, status=&#x27;approved&#x27;, approver_admin_id=1, approval_time=&#x27;2025-12-21 14:30:00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========== 步骤3：用户开始使用设备 ==========</span></span><br><span class="line"><span class="keyword">CALL</span> sp_start_using_equipment(</span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- reservation_id</span></span><br><span class="line">    <span class="number">5</span>,                              <span class="comment">-- user_id（用户身份验证）</span></span><br><span class="line">    <span class="variable">@result</span>, </span><br><span class="line">    <span class="variable">@message</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@result</span>, <span class="variable">@message</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- @result = 1</span></span><br><span class="line"><span class="comment">-- @message = &#x27;开始使用成功&#x27;</span></span><br><span class="line"><span class="comment">-- 预约状态：approved → in_use</span></span><br><span class="line"><span class="comment">-- 触发器 trg_reservation_status_change 自动执行：</span></span><br><span class="line"><span class="comment">--   设备状态：available → in_use</span></span><br><span class="line"><span class="comment">-- 自动创建使用记录，记录开始时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证结果</span></span><br><span class="line"><span class="keyword">SELECT</span> status <span class="keyword">FROM</span> reservation_records <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：status=&#x27;in_use&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> status <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：status=&#x27;in_use&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> id, usage_start_time, usage_status </span><br><span class="line"><span class="keyword">FROM</span> usage_records </span><br><span class="line"><span class="keyword">WHERE</span> reservation_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：id=1, usage_start_time=&#x27;2025-12-22 09:05:00&#x27;, usage_status=&#x27;in_use&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========== 步骤4：用户完成使用 ==========</span></span><br><span class="line"><span class="keyword">CALL</span> sp_complete_using_equipment(</span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- reservation_id</span></span><br><span class="line">    <span class="number">5</span>,                              <span class="comment">-- user_id</span></span><br><span class="line">    <span class="string">&#x27;设备运行正常&#x27;</span>,                  <span class="comment">-- usage_note</span></span><br><span class="line">    <span class="variable">@result</span>, </span><br><span class="line">    <span class="variable">@message</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@result</span>, <span class="variable">@message</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- @result = 1</span></span><br><span class="line"><span class="comment">-- @message = &#x27;使用完成，总时长: 115分钟&#x27;（自动计算）</span></span><br><span class="line"><span class="comment">-- 使用记录状态：in_use → completed</span></span><br><span class="line"><span class="comment">-- 触发器 trg_usage_status_change 执行：</span></span><br><span class="line"><span class="comment">--   预约状态：in_use → completed</span></span><br><span class="line"><span class="comment">-- 触发器 trg_reservation_status_change 执行：</span></span><br><span class="line"><span class="comment">--   检查无其他占用 → 设备状态：in_use → available</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证最终结果</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    r.id, </span><br><span class="line">    r.status <span class="keyword">AS</span> 预约状态,</span><br><span class="line">    u.usage_status <span class="keyword">AS</span> 使用状态,</span><br><span class="line">    u.remark <span class="keyword">AS</span> 备注,</span><br><span class="line">    e.status <span class="keyword">AS</span> 设备状态</span><br><span class="line"><span class="keyword">FROM</span> reservation_records r</span><br><span class="line"><span class="keyword">JOIN</span> usage_records u <span class="keyword">ON</span> u.reservation_id <span class="operator">=</span> r.id</span><br><span class="line"><span class="keyword">JOIN</span> equipment e <span class="keyword">ON</span> e.id <span class="operator">=</span> r.equipment_id</span><br><span class="line"><span class="keyword">WHERE</span> r.id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- id=1, 预约状态=&#x27;completed&#x27;, 使用状态=&#x27;completed&#x27;, </span></span><br><span class="line"><span class="comment">-- 备注=&#x27;设备运行正常 [使用时长: 115分钟]&#x27;, 设备状态=&#x27;available&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="8-1-2-查询设备可用时间段">8.1.2 查询设备可用时间段</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询设备1在本周的预约情况</span></span><br><span class="line"><span class="keyword">CALL</span> sp_get_equipment_available_slots(</span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- equipment_id</span></span><br><span class="line">    <span class="string">&#x27;2025-12-20&#x27;</span>,                   <span class="comment">-- start_date</span></span><br><span class="line">    <span class="string">&#x27;2025-12-27&#x27;</span>                    <span class="comment">-- end_date</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：返回2个结果集</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果集1：设备状态信息</span></span><br><span class="line"><span class="comment">-- equipment_id | equipment_status | availability_message</span></span><br><span class="line"><span class="comment">--      1       |    available     |      可预约</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果集2：已预约时间段</span></span><br><span class="line"><span class="comment">-- reservation_id | expected_start_time  | expected_end_time    | status   | status_text</span></span><br><span class="line"><span class="comment">--       5        | 2025-12-21 09:00:00 | 2025-12-21 11:00:00  | approved |   已批准</span></span><br><span class="line"><span class="comment">--       7        | 2025-12-23 14:00:00 | 2025-12-23 16:00:00  | in_use   |   使用中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 应用说明：</span></span><br><span class="line"><span class="comment">-- 1. 前端根据结果集1判断设备是否可预约</span></span><br><span class="line"><span class="comment">-- 2. 前端根据结果集2渲染日历，显示已占用时间段</span></span><br><span class="line"><span class="comment">-- 3. 用户可选择空闲时间段进行预约</span></span><br></pre></td></tr></table></figure>
<h3 id="8-2-维修管理功能">8.2 维修管理功能</h3>
<h4 id="8-2-1-设备报修完整流程">8.2.1 设备报修完整流程</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ========== 步骤1：用户提交报修 ==========</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> warranty_records (</span><br><span class="line">    equipment_id, </span><br><span class="line">    reported_by, </span><br><span class="line">    fault_description, </span><br><span class="line">    priority, </span><br><span class="line">    status</span><br><span class="line">) <span class="keyword">VALUES</span> (</span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- 设备ID</span></span><br><span class="line">    <span class="number">5</span>,                              <span class="comment">-- 报修人ID</span></span><br><span class="line">    <span class="string">&#x27;设备无法启动，电源指示灯不亮&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;urgent&#x27;</span>,                       <span class="comment">-- 紧急</span></span><br><span class="line">    <span class="string">&#x27;pending&#x27;</span>                       <span class="comment">-- 待分派</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 触发器 trg_warranty_create 自动执行：</span></span><br><span class="line"><span class="comment">--   1. 设备状态：available → maintenance</span></span><br><span class="line"><span class="comment">--   2. 自动创建进度记录：&#x27;用户提交报修&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证结果</span></span><br><span class="line"><span class="keyword">SELECT</span> id, status <span class="keyword">FROM</span> warranty_records <span class="keyword">WHERE</span> id <span class="operator">=</span> LAST_INSERT_ID();</span><br><span class="line"><span class="comment">-- 输出：id=1, status=&#x27;pending&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> status <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：status=&#x27;maintenance&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> note <span class="keyword">FROM</span> warranty_progress <span class="keyword">WHERE</span> warranty_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：note=&#x27;用户提交报修&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========== 步骤2：管理员分派维修任务 ==========</span></span><br><span class="line"><span class="comment">-- 首先查询维修人员工作负荷</span></span><br><span class="line"><span class="keyword">CALL</span> sp_get_maintenance_workload();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果集示例：</span></span><br><span class="line"><span class="comment">-- maintenance_user_id | username      | pending_tasks | recommendation</span></span><br><span class="line"><span class="comment">--          2          | maintenance02 |       0       |   强烈推荐</span></span><br><span class="line"><span class="comment">--          1          | maintenance01 |       3       |     一般</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 选择负荷最轻的人员分派</span></span><br><span class="line"><span class="keyword">CALL</span> sp_assign_maintenance_task(</span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- warranty_id</span></span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- dispatcher_id（管理员ID）</span></span><br><span class="line">    <span class="number">2</span>,                              <span class="comment">-- maintenance_user_id（选择maintenance02）</span></span><br><span class="line">    <span class="string">&#x27;urgent&#x27;</span>,                       <span class="comment">-- priority</span></span><br><span class="line">    <span class="string">&#x27;设备无法启动，优先处理&#x27;</span>,</span><br><span class="line">    <span class="variable">@result</span>, </span><br><span class="line">    <span class="variable">@message</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@result</span>, <span class="variable">@message</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- @result = 1</span></span><br><span class="line"><span class="comment">-- @message = &#x27;任务已分派给 maintenance02&#x27;</span></span><br><span class="line"><span class="comment">-- 维修状态：pending → assigned</span></span><br><span class="line"><span class="comment">-- 记录分派时间和维修人员</span></span><br><span class="line"><span class="comment">-- 自动创建进度记录：&#x27;分派给: maintenance02&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证结果</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    status, </span><br><span class="line">    maintenance_user_id, </span><br><span class="line">    dispatcher_id, </span><br><span class="line">    assigned_at </span><br><span class="line"><span class="keyword">FROM</span> warranty_records </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- status=&#x27;assigned&#x27;, maintenance_user_id=2, dispatcher_id=1, </span></span><br><span class="line"><span class="comment">-- assigned_at=&#x27;2025-12-21 14:35:00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========== 步骤3：维修人员开始维修 ==========</span></span><br><span class="line"><span class="keyword">CALL</span> sp_start_maintenance(</span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- warranty_id</span></span><br><span class="line">    <span class="number">2</span>,                              <span class="comment">-- maintenance_user_id</span></span><br><span class="line">    <span class="string">&#x27;开始检查设备电源系统&#x27;</span>,</span><br><span class="line">    <span class="variable">@result</span>, </span><br><span class="line">    <span class="variable">@message</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@result</span>, <span class="variable">@message</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- @result = 1</span></span><br><span class="line"><span class="comment">-- @message = &#x27;已开始维修&#x27;</span></span><br><span class="line"><span class="comment">-- 维修状态：assigned → in_progress</span></span><br><span class="line"><span class="comment">-- 记录开始时间：started_at = NOW()</span></span><br><span class="line"><span class="comment">-- 触发器 trg_warranty_status_change 确保设备状态为 maintenance</span></span><br><span class="line"><span class="comment">-- 自动创建进度记录：&#x27;开始维修. 开始检查设备电源系统&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证结果</span></span><br><span class="line"><span class="keyword">SELECT</span> status, started_at <span class="keyword">FROM</span> warranty_records <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：status=&#x27;in_progress&#x27;, started_at=&#x27;2025-12-21 15:00:00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========== 步骤4：维修人员完成维修 ==========</span></span><br><span class="line"><span class="keyword">CALL</span> sp_complete_maintenance(</span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- warranty_id</span></span><br><span class="line">    <span class="number">2</span>,                              <span class="comment">-- maintenance_user_id</span></span><br><span class="line">    <span class="string">&#x27;检查发现电源模块损坏，已更换新模块，设备测试正常&#x27;</span>,  <span class="comment">-- solution（必填）</span></span><br><span class="line">    <span class="string">&#x27;电源模块 x1&#x27;</span>,                   <span class="comment">-- parts_used</span></span><br><span class="line">    <span class="variable">@result</span>, </span><br><span class="line">    <span class="variable">@message</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@result</span>, <span class="variable">@message</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- @result = 1</span></span><br><span class="line"><span class="comment">-- @message = &#x27;维修完成，耗时: 2.5小时&#x27;（自动计算：17:30 - 15:00）</span></span><br><span class="line"><span class="comment">-- 维修状态：in_progress → completed</span></span><br><span class="line"><span class="comment">-- 记录完成时间：completed_at = NOW()</span></span><br><span class="line"><span class="comment">-- 自动生成详细维修笔记（包含方案、配件、耗时）</span></span><br><span class="line"><span class="comment">-- 触发器 trg_warranty_status_change 执行：</span></span><br><span class="line"><span class="comment">--   检查无其他维修任务 → 设备状态：maintenance → available</span></span><br><span class="line"><span class="comment">-- 自动创建进度记录：&#x27;维修完成. 方案: 检查发现电源模块损坏...&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证最终结果</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    id,</span><br><span class="line">    status <span class="keyword">AS</span> 维修状态,</span><br><span class="line">    started_at <span class="keyword">AS</span> 开始时间,</span><br><span class="line">    completed_at <span class="keyword">AS</span> 完成时间,</span><br><span class="line">    maintenance_note <span class="keyword">AS</span> 维修笔记</span><br><span class="line"><span class="keyword">FROM</span> warranty_records </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- id=1, 维修状态=&#x27;completed&#x27;, </span></span><br><span class="line"><span class="comment">-- 开始时间=&#x27;2025-12-21 15:00:00&#x27;, </span></span><br><span class="line"><span class="comment">-- 完成时间=&#x27;2025-12-21 17:30:00&#x27;,</span></span><br><span class="line"><span class="comment">-- 维修笔记=&#x27;维修方案: 检查发现电源模块损坏，已更换新模块，设备测试正常 | </span></span><br><span class="line"><span class="comment">--          使用配件: 电源模块 x1 | 维修耗时: 2.5小时&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> status <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：status=&#x27;available&#x27;（已恢复）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询完整维修历史</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    status <span class="keyword">AS</span> 状态,</span><br><span class="line">    actor_role <span class="keyword">AS</span> 操作角色,</span><br><span class="line">    note <span class="keyword">AS</span> 备注,</span><br><span class="line">    created_at <span class="keyword">AS</span> 时间</span><br><span class="line"><span class="keyword">FROM</span> warranty_progress </span><br><span class="line"><span class="keyword">WHERE</span> warranty_id <span class="operator">=</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- 状态      | 操作角色    | 备注                                      | 时间</span></span><br><span class="line"><span class="comment">-- pending   | normal      | 用户提交报修                               | 2025-12-21 14:30:00</span></span><br><span class="line"><span class="comment">-- assigned  | admin       | 分派给: maintenance02. 设备无法启动...     | 2025-12-21 14:35:00</span></span><br><span class="line"><span class="comment">-- in_progress| maintenance| 开始维修. 开始检查设备电源系统              | 2025-12-21 15:00:00</span></span><br><span class="line"><span class="comment">-- completed | maintenance | 维修完成. 方案: 检查发现电源模块损坏...     | 2025-12-21 17:30:00</span></span><br></pre></td></tr></table></figure>
<h4 id="8-2-2-维修人员工作负荷查询">8.2.2 维修人员工作负荷查询</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询所有维修人员的工作负荷</span></span><br><span class="line"><span class="keyword">CALL</span> sp_get_maintenance_workload();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果集示例：</span></span><br><span class="line"><span class="comment">-- maintenance_user_id | username      | expertise  | pending_tasks | in_progress_tasks | urgent_tasks | completed_this_month | avg_completion_hours | recommendation</span></span><br><span class="line"><span class="comment">--          3          | maintenance03 | 电气维修    |       0       |        0          |      0       |          5           |         2.3          |   强烈推荐</span></span><br><span class="line"><span class="comment">--          1          | maintenance01 | 电气维修    |       1       |        1          |      0       |          8           |         2.8          |     推荐</span></span><br><span class="line"><span class="comment">--          2          | maintenance02 | 机械设备    |       2       |        2          |      1       |         10           |         3.2          |     一般</span></span><br><span class="line"><span class="comment">--          4          | maintenance04 | 电子设备    |       4       |        3          |      2       |         12           |         4.1          |     繁忙</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 1. 按工作负荷从轻到重排序</span></span><br><span class="line"><span class="comment">-- 2. recommendation 推荐指数基于未完成任务数计算</span></span><br><span class="line"><span class="comment">-- 3. avg_completion_hours 显示历史平均效率</span></span><br><span class="line"><span class="comment">-- 4. urgent_tasks 显示当前紧急任务压力</span></span><br><span class="line"><span class="comment">-- 5. completed_this_month 显示本月绩效</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 应用场景：</span></span><br><span class="line"><span class="comment">-- 管理员分派任务前，优先选择&quot;强烈推荐&quot;或&quot;推荐&quot;的人员</span></span><br></pre></td></tr></table></figure>
<h3 id="8-3-采购管理功能">8.3 采购管理功能</h3>
<h4 id="8-3-1-采购工单完整流程">8.3.1 采购工单完整流程</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ========== 步骤1：维修人员创建采购申请 ==========</span></span><br><span class="line"><span class="keyword">CALL</span> sp_create_purchase_order(</span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- maintenance_request_id（关联维修记录）</span></span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- equipment_id（关联设备）</span></span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- part_id（传感器模块）</span></span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- part_manufacturer_id（精密仪器公司）</span></span><br><span class="line">    <span class="number">5</span>,                              <span class="comment">-- quantity（采购5个）</span></span><br><span class="line">    <span class="number">2</span>,                              <span class="comment">-- requester_id（维修人员ID）</span></span><br><span class="line">    <span class="string">&#x27;设备传感器损坏，需更换5个传感器模块&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;urgent&#x27;</span>,                       <span class="comment">-- urgency（紧急）</span></span><br><span class="line">    <span class="string">&#x27;2025-12-25&#x27;</span>,                   <span class="comment">-- expected_delivery_date</span></span><br><span class="line">    <span class="variable">@result</span>, </span><br><span class="line">    <span class="variable">@message</span>, </span><br><span class="line">    <span class="variable">@order_id</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@result</span> <span class="keyword">AS</span> 结果码, <span class="variable">@message</span> <span class="keyword">AS</span> 消息, <span class="variable">@order_id</span> <span class="keyword">AS</span> 工单ID;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- @result = 1</span></span><br><span class="line"><span class="comment">-- @message = &#x27;采购工单创建成功 [PO202512211430450123] 传感器模块 x5 </span></span><br><span class="line"><span class="comment">--             厂商:精密仪器制造有限公司 金额:￥227.50&#x27;</span></span><br><span class="line"><span class="comment">-- @order_id = 15（新创建的工单ID）</span></span><br><span class="line"><span class="comment">-- 工单状态：pending</span></span><br><span class="line"><span class="comment">-- 触发器 trg_purchase_create 自动执行：</span></span><br><span class="line"><span class="comment">--   创建初始进度记录：&#x27;创建采购申请&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证结果</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    id, </span><br><span class="line">    order_number <span class="keyword">AS</span> 工单编号, </span><br><span class="line">    status <span class="keyword">AS</span> 状态, </span><br><span class="line">    unit_price <span class="operator">*</span> quantity <span class="keyword">AS</span> 总金额 </span><br><span class="line"><span class="keyword">FROM</span> purchase_orders </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="variable">@order_id</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- id=15, 工单编号=&#x27;PO202512211430450123&#x27;, 状态=&#x27;pending&#x27;, 总金额=227.50</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> note <span class="keyword">FROM</span> purchase_order_progress <span class="keyword">WHERE</span> purchase_order_id <span class="operator">=</span> <span class="variable">@order_id</span>;</span><br><span class="line"><span class="comment">-- 输出：note=&#x27;创建采购申请&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========== 步骤2：管理员审批采购工单 ==========</span></span><br><span class="line"><span class="keyword">CALL</span> sp_approve_purchase_order(</span><br><span class="line">    <span class="variable">@order_id</span>,                      <span class="comment">-- order_id（使用上一步返回的ID）</span></span><br><span class="line">    <span class="number">1</span>,                              <span class="comment">-- approver_id（管理员ID）</span></span><br><span class="line">    <span class="literal">TRUE</span>,                           <span class="comment">-- approved（批准）</span></span><br><span class="line">    <span class="string">&#x27;同意采购，注意验收质量&#x27;</span>,</span><br><span class="line">    <span class="variable">@result</span>, </span><br><span class="line">    <span class="variable">@message</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@result</span>, <span class="variable">@message</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- @result = 1</span></span><br><span class="line"><span class="comment">-- @message = &#x27;采购工单 [PO202512211430450123] 已批准&#x27;</span></span><br><span class="line"><span class="comment">-- 工单状态：pending → approved</span></span><br><span class="line"><span class="comment">-- 记录审批人和审批时间</span></span><br><span class="line"><span class="comment">-- 触发器 trg_purchase_status_change 自动执行：</span></span><br><span class="line"><span class="comment">--   创建进度记录：&#x27;审批通过: 同意采购，注意验收质量&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证结果</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    status, </span><br><span class="line">    approver_id, </span><br><span class="line">    approval_time, </span><br><span class="line">    approval_note </span><br><span class="line"><span class="keyword">FROM</span> purchase_orders </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="variable">@order_id</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- status=&#x27;approved&#x27;, approver_id=1, </span></span><br><span class="line"><span class="comment">-- approval_time=&#x27;2025-12-21 14:40:00&#x27;, </span></span><br><span class="line"><span class="comment">-- approval_note=&#x27;同意采购，注意验收质量&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询完整审批历史</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    status <span class="keyword">AS</span> 状态,</span><br><span class="line">    operator_id <span class="keyword">AS</span> 操作人ID,</span><br><span class="line">    note <span class="keyword">AS</span> 备注,</span><br><span class="line">    created_at <span class="keyword">AS</span> 时间</span><br><span class="line"><span class="keyword">FROM</span> purchase_order_progress </span><br><span class="line"><span class="keyword">WHERE</span> purchase_order_id <span class="operator">=</span> <span class="variable">@order_id</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- 状态     | 操作人ID | 备注                                  | 时间</span></span><br><span class="line"><span class="comment">-- pending  |    2     | 创建采购申请                          | 2025-12-21 14:35:00</span></span><br><span class="line"><span class="comment">-- approved |    1     | 审批通过: 同意采购，注意验收质量       | 2025-12-21 14:40:00</span></span><br></pre></td></tr></table></figure>
<h4 id="8-3-2-采购统计分析">8.3.2 采购统计分析</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询2025年全年采购统计</span></span><br><span class="line"><span class="keyword">CALL</span> sp_get_purchase_statistics(<span class="string">&#x27;2025-01-01&#x27;</span>, <span class="string">&#x27;2025-12-31&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果集1：汇总统计</span></span><br><span class="line"><span class="comment">-- total_orders | pending_count | approved_count | rejected_count | approved_amount | avg_approval_hours</span></span><br><span class="line"><span class="comment">--     125      |      15       |       98       |       12       |   125680.50     |       4.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- total_orders: 总工单数125个</span></span><br><span class="line"><span class="comment">-- approved_count: 已批准98个</span></span><br><span class="line"><span class="comment">-- approved_amount: 已批准总金额125,680.50元</span></span><br><span class="line"><span class="comment">-- avg_approval_hours: 平均审批时长4.2小时</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果集2：按零件分类统计</span></span><br><span class="line"><span class="comment">-- category    | order_count | total_quantity | total_amount</span></span><br><span class="line"><span class="comment">-- 电子元件     |     45      |      230       |  56780.00</span></span><br><span class="line"><span class="comment">-- 机械部件     |     30      |      120       |  42900.00</span></span><br><span class="line"><span class="comment">-- 显示设备     |     15      |       45       |  17100.00</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 电子元件采购最多，占总金额的45%</span></span><br><span class="line"><span class="comment">-- 按金额降序排列</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果集3：按厂商统计</span></span><br><span class="line"><span class="comment">-- manufacturer_name        | order_count | total_quantity | total_amount</span></span><br><span class="line"><span class="comment">-- 精密仪器制造有限公司      |     35      |      150       |  68900.00</span></span><br><span class="line"><span class="comment">-- 电子元件供应商           |     40      |      180       |  38760.00</span></span><br><span class="line"><span class="comment">-- 机械配件厂              |     23      |       90       |  18020.00</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 精密仪器公司是最大供应商，金额占比54.7%</span></span><br><span class="line"><span class="comment">-- 为采购决策和供应商管理提供数据支持</span></span><br></pre></td></tr></table></figure>
<h3 id="8-4-用户管理功能">8.4 用户管理功能</h3>
<h4 id="8-4-1-用户注册与登录">8.4.1 用户注册与登录</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ========== 用户注册 ==========</span></span><br><span class="line"><span class="comment">-- 注册普通用户（应用层会先进行密码加密）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> normal_users (</span><br><span class="line">    username, </span><br><span class="line">    password,                       <span class="comment">-- 已加密的密码</span></span><br><span class="line">    email, </span><br><span class="line">    phone, </span><br><span class="line">    college</span><br><span class="line">) <span class="keyword">VALUES</span> (</span><br><span class="line">    <span class="string">&#x27;user03&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYuYVo3xtvu&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;user03@example.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;13800138003&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;计算机学院&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 新增用户记录，ID自动生成</span></span><br><span class="line"><span class="comment">-- username 字段有唯一约束，防止重复注册</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证结果</span></span><br><span class="line"><span class="keyword">SELECT</span> id, username, email, college </span><br><span class="line"><span class="keyword">FROM</span> normal_users </span><br><span class="line"><span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;user03&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- id=3, username=&#x27;user03&#x27;, email=&#x27;user03@example.com&#x27;, college=&#x27;计算机学院&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========== 用户登录验证 ==========</span></span><br><span class="line"><span class="comment">-- 根据用户名查询用户信息（应用层会验证密码）</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    id, </span><br><span class="line">    username, </span><br><span class="line">    password, </span><br><span class="line">    email, </span><br><span class="line">    phone, </span><br><span class="line">    avatar, </span><br><span class="line">    college,</span><br><span class="line">    <span class="string">&#x27;normal&#x27;</span> <span class="keyword">AS</span> role                <span class="comment">-- 角色标识</span></span><br><span class="line"><span class="keyword">FROM</span> normal_users </span><br><span class="line"><span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;user03&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 返回用户完整信息</span></span><br><span class="line"><span class="comment">-- 应用层比对密码哈希值</span></span><br><span class="line"><span class="comment">-- 验证通过后生成JWT token</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========== 统一用户查询（使用视图） ==========</span></span><br><span class="line"><span class="comment">-- 查询所有类型的用户（通过视图）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v_all_users <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;user03&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- id | username | email              | phone       | role   | user_type</span></span><br><span class="line"><span class="comment">-- 3  | user03   | user03@example.com | 13800138003 | user   | normal</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- v_all_users 视图合并了三类用户表</span></span><br><span class="line"><span class="comment">-- role 字段区分用户类型（admin/user/maintenance）</span></span><br><span class="line"><span class="comment">-- 便于系统统一处理用户信息</span></span><br></pre></td></tr></table></figure>
<h4 id="8-4-2-用户信息更新">8.4.2 用户信息更新</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 更新用户个人信息</span></span><br><span class="line"><span class="keyword">UPDATE</span> normal_users </span><br><span class="line"><span class="keyword">SET</span> </span><br><span class="line">    email <span class="operator">=</span> <span class="string">&#x27;newemail@example.com&#x27;</span>,</span><br><span class="line">    phone <span class="operator">=</span> <span class="string">&#x27;13900139000&#x27;</span>,</span><br><span class="line">    avatar <span class="operator">=</span> <span class="string">&#x27;/uploads/avatars/user03.jpg&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 更新用户的邮箱、电话、头像</span></span><br><span class="line"><span class="comment">-- 不允许修改用户名（UNIQUE约束保护）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证结果</span></span><br><span class="line"><span class="keyword">SELECT</span> username, email, phone, avatar </span><br><span class="line"><span class="keyword">FROM</span> normal_users </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出：</span></span><br><span class="line"><span class="comment">-- username=&#x27;user03&#x27;, email=&#x27;newemail@example.com&#x27;, </span></span><br><span class="line"><span class="comment">-- phone=&#x27;13900139000&#x27;, avatar=&#x27;/uploads/avatars/user03.jpg&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="8-5-设备管理功能">8.5 设备管理功能</h3>
<h4 id="8-5-1-设备状态自动同步">8.5.1 设备状态自动同步</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 场景：设备同时有预约和维修</span></span><br><span class="line"><span class="comment">-- 验证设备状态优先级：maintenance &gt; in_use &gt; available</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 初始状态</span></span><br><span class="line"><span class="keyword">SELECT</span> id, equipment_code, status <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：id=1, equipment_code=&#x27;DEV001&#x27;, status=&#x27;available&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步骤1：创建预约并开始使用</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> reservation_records (...) <span class="keyword">VALUES</span> (...);</span><br><span class="line"><span class="keyword">CALL</span> sp_start_using_equipment(<span class="number">1</span>, <span class="number">5</span>, <span class="variable">@r</span>, <span class="variable">@m</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> status <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：status=&#x27;in_use&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步骤2：设备使用中突然报修</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> warranty_records (equipment_id, reported_by, fault_description, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">5</span>, <span class="string">&#x27;使用过程中发现异常&#x27;</span>, <span class="string">&#x27;pending&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 触发器 trg_warranty_create 自动执行：</span></span><br><span class="line"><span class="comment">--   设备状态：in_use → maintenance（维修优先级更高）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> status <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：status=&#x27;maintenance&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步骤3：用户完成使用（但维修未完成）</span></span><br><span class="line"><span class="keyword">CALL</span> sp_complete_using_equipment(<span class="number">1</span>, <span class="number">5</span>, <span class="string">&#x27;使用中断&#x27;</span>, <span class="variable">@r</span>, <span class="variable">@m</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 触发器 trg_reservation_status_change 执行：</span></span><br><span class="line"><span class="comment">--   检查到有未完成的维修任务</span></span><br><span class="line"><span class="comment">--   设备状态保持：maintenance（不变）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> status <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：status=&#x27;maintenance&#x27;（仍为维修状态）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步骤4：维修完成</span></span><br><span class="line"><span class="keyword">CALL</span> sp_complete_maintenance(<span class="number">1</span>, <span class="number">2</span>, <span class="string">&#x27;已维修&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">@r</span>, <span class="variable">@m</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 触发器 trg_warranty_status_change 执行：</span></span><br><span class="line"><span class="comment">--   检查无其他维修任务</span></span><br><span class="line"><span class="comment">--   检查无使用中的预约</span></span><br><span class="line"><span class="comment">--   设备状态：maintenance → available</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> status <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 输出：status=&#x27;available&#x27;（恢复可用）</span></span><br></pre></td></tr></table></figure>
<p><strong>状态优先级验证表</strong>：</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>维修任务</th>
<th>使用中预约</th>
<th>设备状态</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>有</td>
<td>有</td>
<td><code>maintenance</code></td>
<td>维修最高优先级</td>
</tr>
<tr>
<td>2</td>
<td>有</td>
<td>无</td>
<td><code>maintenance</code></td>
<td>有维修即为维修中</td>
</tr>
<tr>
<td>3</td>
<td>无</td>
<td>有</td>
<td><code>in_use</code></td>
<td>无维修，有使用</td>
</tr>
<tr>
<td>4</td>
<td>无</td>
<td>无</td>
<td><code>available</code></td>
<td>完全空闲</td>
</tr>
</tbody>
</table>
<h4 id="8-5-2-设备列表查询">8.5.2 设备列表查询</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询所有可用设备</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    id,</span><br><span class="line">    equipment_code <span class="keyword">AS</span> 设备编号,</span><br><span class="line">    equipment_name <span class="keyword">AS</span> 设备名称,</span><br><span class="line">    category <span class="keyword">AS</span> 分类,</span><br><span class="line">    status <span class="keyword">AS</span> 状态,</span><br><span class="line">    location <span class="keyword">AS</span> 位置</span><br><span class="line"><span class="keyword">FROM</span> equipment </span><br><span class="line"><span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">&#x27;available&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> category, equipment_code;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出示例：</span></span><br><span class="line"><span class="comment">-- id | 设备编号 | 设备名称        | 分类      | 状态      | 位置</span></span><br><span class="line"><span class="comment">-- 1  | DEV001  | 高性能计算机     | 计算机设备 | available | 实验室A-101</span></span><br><span class="line"><span class="comment">-- 2  | DEV002  | 激光测距仪       | 测量工具   | available | 实验室B-205</span></span><br><span class="line"><span class="comment">-- 4  | DEV004  | 彩色激光打印机   | 办公设备   | available | 办公室-102</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询维修中的设备</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    e.equipment_code,</span><br><span class="line">    e.equipment_name,</span><br><span class="line">    w.fault_description <span class="keyword">AS</span> 故障描述,</span><br><span class="line">    w.priority <span class="keyword">AS</span> 优先级,</span><br><span class="line">    m.username <span class="keyword">AS</span> 维修人员,</span><br><span class="line">    w.status <span class="keyword">AS</span> 维修状态</span><br><span class="line"><span class="keyword">FROM</span> equipment e</span><br><span class="line"><span class="keyword">JOIN</span> warranty_records w <span class="keyword">ON</span> e.id <span class="operator">=</span> w.equipment_id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> maintenance_users m <span class="keyword">ON</span> w.maintenance_user_id <span class="operator">=</span> m.id</span><br><span class="line"><span class="keyword">WHERE</span> e.status <span class="operator">=</span> <span class="string">&#x27;maintenance&#x27;</span> </span><br><span class="line">  <span class="keyword">AND</span> w.status <span class="keyword">IN</span> (<span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;assigned&#x27;</span>, <span class="string">&#x27;in_progress&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> w.priority <span class="keyword">DESC</span>, w.created_at;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出示例：</span></span><br><span class="line"><span class="comment">-- equipment_code | equipment_name | 故障描述              | 优先级 | 维修人员      | 维修状态</span></span><br><span class="line"><span class="comment">-- DEV005        | 三维扫描仪      | 扫描精度下降          | urgent | maintenance02 | in_progress</span></span><br><span class="line"><span class="comment">-- DEV003        | 数字示波器      | 显示屏出现横线         | normal | maintenance01 | assigned</span></span><br></pre></td></tr></table></figure>
<h3 id="8-6-数据完整性验证">8.6 数据完整性验证</h3>
<h4 id="8-6-1-外键约束测试">8.6.1 外键约束测试</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试：尝试删除有预约记录的设备</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 错误：Cannot delete or update a parent row: a foreign key constraint fails</span></span><br><span class="line"><span class="comment">-- 外键约束生效，保护数据完整性</span></span><br><span class="line"><span class="comment">-- 必须先删除或更新关联的预约记录</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试：级联删除（ON DELETE CASCADE）</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> equipment <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 设备被删除</span></span><br><span class="line"><span class="comment">-- 关联的预约记录（reservation_records）自动级联删除</span></span><br><span class="line"><span class="comment">-- 关联的维修记录（warranty_records）自动级联删除</span></span><br><span class="line"><span class="comment">-- 确保数据库不存在孤儿记录</span></span><br></pre></td></tr></table></figure>
<h4 id="8-6-2-唯一约束测试">8.6.2 唯一约束测试</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试：尝试注册重复用户名</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> normal_users (username, password, email)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;user01&#x27;</span>, <span class="string">&#x27;password123&#x27;</span>, <span class="string">&#x27;duplicate@example.com&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 错误：Duplicate entry &#x27;user01&#x27; for key &#x27;username&#x27;</span></span><br><span class="line"><span class="comment">-- UNIQUE KEY 约束生效</span></span><br><span class="line"><span class="comment">-- 防止用户名重复</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试：尝试创建重复设备编号</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> equipment (equipment_code, equipment_name, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;DEV001&#x27;</span>, <span class="string">&#x27;重复设备&#x27;</span>, <span class="string">&#x27;available&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 错误：Duplicate entry &#x27;DEV001&#x27; for key &#x27;equipment_code&#x27;</span></span><br><span class="line"><span class="comment">-- 确保设备编号唯一性</span></span><br></pre></td></tr></table></figure>
<h3 id="8-7-性能优化验证">8.7 性能优化验证</h3>
<h4 id="8-7-1-索引使用验证">8.7.1 索引使用验证</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询某个用户的所有预约记录</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> reservation_records <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- type: ref（使用索引）</span></span><br><span class="line"><span class="comment">-- possible_keys: idx_reservation_user</span></span><br><span class="line"><span class="comment">-- key: idx_reservation_user（实际使用的索引）</span></span><br><span class="line"><span class="comment">-- rows: 10（扫描行数少，性能好）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询某设备的所有预约记录</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> reservation_records <span class="keyword">WHERE</span> equipment_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- key: idx_reservation_equipment</span></span><br><span class="line"><span class="comment">-- 使用设备ID索引，查询效率高</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询待审批的预约</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> reservation_records <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- key: idx_reservation_status</span></span><br><span class="line"><span class="comment">-- 使用状态索引，快速筛选</span></span><br></pre></td></tr></table></figure>
<h4 id="8-7-2-并发控制验证">8.7.2 并发控制验证</h4>
<p><strong>完整操作流程代码示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 连接1（管理员A）</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">CALL</span> sp_approve_reservation(<span class="number">1</span>, <span class="number">1</span>, <span class="literal">TRUE</span>, <span class="string">&#x27;Admin A&#x27;</span>, <span class="variable">@r</span>, <span class="variable">@m</span>);</span><br><span class="line"><span class="comment">-- 获取行级锁，等待10秒</span></span><br><span class="line"><span class="keyword">SELECT</span> SLEEP(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 连接2（管理员B，同时操作）</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">CALL</span> sp_approve_reservation(<span class="number">1</span>, <span class="number">2</span>, <span class="literal">TRUE</span>, <span class="string">&#x27;Admin B&#x27;</span>, <span class="variable">@r</span>, <span class="variable">@m</span>);</span><br><span class="line"><span class="comment">-- 会被阻塞，等待连接1释放锁</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果说明：</span></span><br><span class="line"><span class="comment">-- 连接2被阻塞，直到连接1 COMMIT</span></span><br><span class="line"><span class="comment">-- 连接2执行时发现状态已变为&#x27;approved&#x27;</span></span><br><span class="line"><span class="comment">-- 返回错误：@result=-3, @message=&#x27;预约状态不允许审批: approved&#x27;</span></span><br><span class="line"><span class="comment">-- SELECT FOR UPDATE 行级锁防止了并发冲突</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="九、总结">九、总结</h2>
<p><strong>King_CB</strong>：</p>
<p>在本次实验室设备管理系统的项目中，我主要负责预约管理模块、用户管理模块以及系统整体架构与数据库设计部分。</p>
<p>在预约管理模块中，我设计了完整的设备预约流程，包括预约提交、审批、开始使用和完成使用等状态流转。通过<code>sp_approve_reservation</code>、<code>sp_start_using_equipment</code>等存储过程，封装了复杂的业务规则（如时间冲突检测、身份验证、状态检查等），并利用触发器（如<code>trg_reservation_status_change</code>）自动维护设备状态，确保设备在“可用”、“使用中”、“维修中”等状态间的正确切换。特别是时间冲突检测算法（<code>start1 &lt; end2 AND end1 &gt; start2</code>）的设计，有效防止了设备被重复预约，保障了预约资源的合理分配。</p>
<p>在用户管理方面，我参与了多角色用户表（管理员、普通用户、维修人员）的设计，并通过视图<code>v_all_users</code>实现了用户信息的统一查询接口。同时，在应用层配合使用<code>bcrypt</code>加密和<code>JWT</code>认证，确保了用户数据的安全性与登录验证的可靠性。</p>
<p>最大的收获来自于对“数据库不仅是存储数据，更是封装业务逻辑”这一理念的亲身实践。在调试设备状态同步触发器、处理并发审批的行级锁时，我不断加深了对数据一致性、事务隔离级别等概念的理解。这次项目让我认识到，扎实的数据库设计能力是构建可靠后端系统的基石，也为我今后从事软件开发工作积累了宝贵的经验。</p>
<p><strong>Boomfreezing</strong>：</p>
<p>在本次实验室设备管理系统项目中，我主要负责维修管理模块、零件采购系统以及最终实现报告的大部分撰写工作。通过将数据库理论与实际业务深度结合，我对数据库设计中数据完整性、一致性保障有了更直观和深入的理解。</p>
<p>维修管理模块覆盖了从用户报修、任务分派到维修完成的完整流程，零件采购系统则涉及零件、厂商及采购工单等多表关联逻辑。这两部分均为系统核心功能，对业务流程规范性和数据一致性要求较高。项目中主要难点包括：设备状态在预约与维修并存时的自动同步、维修流程中的时间计算与进度审计，以及采购工单与维修任务之间的可追溯关联设计。</p>
<p>针对上述问题，我采用了“触发器 + 存储过程 + 约束”的三层机制：通过统一的状态计算函数和触发器实现设备状态自动同步；将维修流程封装进存储过程，并结合事务与行级锁保证并发安全和审计完整性；在采购管理中实现自动生成工单编号和状态变更记录，确保流程可追溯。</p>
<p>通过本次实践，我深刻体会到数据库设计不仅是建表和写 SQL，更是对业务逻辑的系统抽象与数据一致性的整体保障。这次项目不仅提升了我对 MySQL 高级特性的实际应用能力，也锻炼了我分析复杂业务、系统化解决问题以及技术文档撰写的能力，对今后的软件开发学习和实践具有重要意义。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://Boomfreezing.github.io">Boom_freezing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://boomfreezing.github.io/2025/12/29/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/">http://boomfreezing.github.io/2025/12/29/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://Boomfreezing.github.io" target="_blank">Boomfreezing</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><a class="post-meta__tags" href="/tags/TaurusDB/">TaurusDB</a><a class="post-meta__tags" href="/tags/python/">python</a><a class="post-meta__tags" href="/tags/SQL/">SQL</a><a class="post-meta__tags" href="/tags/Vue/">Vue</a><a class="post-meta__tags" href="/tags/Flask/">Flask</a><a class="post-meta__tags" href="/tags/E-R%E5%9B%BE/">E-R图</a><a class="post-meta__tags" href="/tags/%E8%A7%A6%E5%8F%91%E5%99%A8/">触发器</a><a class="post-meta__tags" href="/tags/%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B/">存储过程</a></div><div class="post-share"><div class="social-share" data-image="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/12/28/%E6%9C%80%E4%BC%98%E5%8C%96%E5%A4%8D%E4%B9%A0%E6%8F%90%E7%BA%B2/" title="最优化复习提纲"><img class="cover" src="/images/%E6%9C%80%E4%BC%98%E5%8C%96/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">最优化复习提纲</div></div><div class="info-2"><div class="info-item-1">最优化考试复习提纲</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Boom_freezing</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">9</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Boomfreezing"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Welcome to Boom_freezing's Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">实验室设备管理系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%B6%E3%80%81%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.</span> <span class="toc-text">零、说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-1-%E8%B4%A1%E7%8C%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.1.</span> <span class="toc-text">0.1 贡献说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0-2-%E4%BB%A3%E7%A0%81%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.2.</span> <span class="toc-text">0.2 代码说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0-3-%E5%85%B1%E5%88%9B%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.3.</span> <span class="toc-text">0.3 共创说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">一、需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%9C%80%E6%B1%82%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 需求描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%B3%BB%E7%BB%9F%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 系统功能设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">2.1 普通用户功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E7%AE%A1%E7%90%86%E5%91%98%E7%94%A8%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">2.2 管理员用户功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E7%BB%B4%E4%BF%AE%E4%BA%BA%E5%91%98%E7%94%A8%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">2.3 维修人员用户功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 数据流图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E9%A1%B6%E5%B1%82%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">3.1 顶层数据流图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">3.2 业务数据流图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%95%B0%E6%8D%AE%E5%85%83%E7%B4%A0%E8%A1%A8"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. 数据元素表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">(1) 普通用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">(2) 管理员</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%BB%B4%E4%BF%AE%E4%BA%BA%E5%91%98"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">(3) 维修人员</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%AE%9E%E9%AA%8C%E5%AE%A4"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">(4) 实验室</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E8%AE%BE%E5%A4%87"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">(5) 设备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E9%A2%84%E7%BA%A6%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.4.6.</span> <span class="toc-text">(6) 预约记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.4.7.</span> <span class="toc-text">(7) 使用记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E7%BB%B4%E4%BF%AE%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.4.8.</span> <span class="toc-text">(8) 维修记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-%E6%8A%A5%E4%BF%AE%E8%BF%9B%E5%BA%A6%E5%8F%98%E5%8C%96%E8%A1%A8"><span class="toc-number">1.2.4.9.</span> <span class="toc-text">(9) 报修进度变化表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-%E9%9B%B6%E4%BB%B6"><span class="toc-number">1.2.4.10.</span> <span class="toc-text">(10) 零件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-%E7%94%9F%E4%BA%A7%E5%8E%82%E5%95%86%E8%A1%A8"><span class="toc-number">1.2.4.11.</span> <span class="toc-text">(11) 生产厂商表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-%E9%9B%B6%E4%BB%B6-%E7%94%9F%E4%BA%A7%E5%95%86%E5%85%B3%E8%81%94%E8%A1%A8"><span class="toc-number">1.2.4.12.</span> <span class="toc-text">(12) 零件-生产商关联表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-%E9%87%87%E8%B4%AD%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.4.13.</span> <span class="toc-text">(13) 采购记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-%E9%87%87%E8%B4%AD%E5%B7%A5%E5%8D%95%E8%BF%9B%E5%BA%A6%E8%A1%A8"><span class="toc-number">1.2.4.14.</span> <span class="toc-text">(14) 采购工单进度表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A6%82%E5%BF%B5%E6%A8%A1%E5%BC%8F%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.3.</span> <span class="toc-text">二、数据库概念模式设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%B3%BB%E7%BB%9F%E5%88%9D%E6%AD%A5E-R%E5%9B%BE"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 系统初步E-R图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%B3%BB%E7%BB%9F%E5%9F%BA%E6%9C%AC-E-R-%E5%9B%BE"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 系统基本 E-R 图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E9%80%BB%E8%BE%91%E6%A8%A1%E5%BC%8F%E8%AE%BE%E8%AE%A1%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="toc-number">1.4.</span> <span class="toc-text">三、数据库逻辑模式设计与优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%BC%8F%E5%AE%9A%E4%B9%89"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. 数据库关系模式定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%AE%9E%E4%BD%93%E7%9A%84%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">1.1 实体的关系模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E8%81%94%E7%B3%BB%E7%9A%84%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">1.2 联系的关系模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%BC%8F%E8%8C%83%E5%BC%8F%E7%AD%89%E7%BA%A7%E7%9A%84%E5%88%A4%E5%AE%9A%E4%B8%8E%E8%A7%84%E8%8C%83%E5%8C%96"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. 关系模式范式等级的判定与规范化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%AE%9E%E4%BD%93%E7%9A%84%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%BC%8F%EF%BC%88%E8%A7%84%E8%8C%83%E5%8C%96%E5%90%8E%EF%BC%89"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">2.1 实体的关系模式（规范化后）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E8%81%94%E7%B3%BB%E7%9A%84%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%BC%8F%EF%BC%88%E8%A7%84%E8%8C%83%E5%8C%96%E5%90%8E%EF%BC%89"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">2.2 联系的关系模式（规范化后）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%BC%8F%E4%BC%98%E5%8C%96"><span class="toc-number">1.4.3.</span> <span class="toc-text">3. 数据库关系模式优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%AE%9E%E4%BD%93%E7%9A%84%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%BC%8F%EF%BC%88%E4%BC%98%E5%8C%96%E5%90%8E%EF%BC%89"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">3.1 实体的关系模式（优化后）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E8%81%94%E7%B3%BB%E7%9A%84%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%BC%8F%EF%BC%88%E4%BC%98%E5%8C%96%E5%90%8E%EF%BC%89"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">3.2 联系的关系模式（优化后）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%A9%E7%90%86%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.5.</span> <span class="toc-text">四、数据库物理设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.6.</span> <span class="toc-text">五、系统结构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.1.</span> <span class="toc-text">5.1 体系结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84%E5%8F%8A%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">5.1.1 前端架构及技术栈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84%E5%8F%8A%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">5.1.2 后端架构及技术栈</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E8%A1%A8%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.7.</span> <span class="toc-text">六、数据库基本表的定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%AE%A1%E7%90%86%E5%91%98%E8%A1%A8"><span class="toc-number">1.7.1.</span> <span class="toc-text">6.1 管理员表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E8%A1%A8"><span class="toc-number">1.7.2.</span> <span class="toc-text">6.2 普通用户表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E7%BB%B4%E4%BF%AE%E5%91%98%E8%A1%A8"><span class="toc-number">1.7.3.</span> <span class="toc-text">6.3 维修员表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E5%AE%9E%E9%AA%8C%E5%AE%A4%E8%A1%A8"><span class="toc-number">1.7.4.</span> <span class="toc-text">6.4 实验室表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E8%AE%BE%E5%A4%87%E8%A1%A8"><span class="toc-number">1.7.5.</span> <span class="toc-text">6.5 设备表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E9%A2%84%E7%BA%A6%E8%AE%B0%E5%BD%95%E8%A1%A8"><span class="toc-number">1.7.6.</span> <span class="toc-text">6.6 预约记录表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95%E8%A1%A8"><span class="toc-number">1.7.7.</span> <span class="toc-text">6.7 使用记录表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-%E6%8A%A5%E4%BF%AE%E8%AE%B0%E5%BD%95%E8%A1%A8"><span class="toc-number">1.7.8.</span> <span class="toc-text">6.8 报修记录表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-9-%E6%8A%A5%E4%BF%AE%E8%BF%9B%E5%BA%A6%E8%A1%A8"><span class="toc-number">1.7.9.</span> <span class="toc-text">6.9 报修进度表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-10-%E7%94%9F%E4%BA%A7%E5%8E%82%E5%95%86%E8%A1%A8"><span class="toc-number">1.7.10.</span> <span class="toc-text">6.10 生产厂商表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-11-%E9%9B%B6%E4%BB%B6%E8%A1%A8"><span class="toc-number">1.7.11.</span> <span class="toc-text">6.11 零件表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-12-%E9%9B%B6%E4%BB%B6-%E7%94%9F%E4%BA%A7%E5%8E%82%E5%95%86%E5%85%B3%E8%81%94%E8%A1%A8"><span class="toc-number">1.7.12.</span> <span class="toc-text">6.12 零件-生产厂商关联表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-13-%E9%87%87%E8%B4%AD%E5%B7%A5%E5%8D%95%E8%A1%A8"><span class="toc-number">1.7.13.</span> <span class="toc-text">6.13 采购工单表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-14-%E9%87%87%E8%B4%AD%E5%B7%A5%E5%8D%95%E8%BF%9B%E5%BA%A6%E8%AE%B0%E5%BD%95%E8%A1%A8"><span class="toc-number">1.7.14.</span> <span class="toc-text">6.14 采购工单进度记录表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E8%A7%A6%E5%8F%91%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">1.8.</span> <span class="toc-text">七、触发器与存储过程的设计与实现说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E8%A7%A6%E5%8F%91%E5%99%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.8.1.</span> <span class="toc-text">7.1 触发器系统设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-1-%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0%EF%BC%9A%E8%AE%BE%E5%A4%87%E7%8A%B6%E6%80%81%E8%AE%A1%E7%AE%97"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">7.1.1 辅助函数：设备状态计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-2-%E8%BE%85%E5%8A%A9%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%EF%BC%9A%E5%90%8C%E6%AD%A5%E8%AE%BE%E5%A4%87%E7%8A%B6%E6%80%81"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">7.1.2 辅助存储过程：同步设备状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-3-%E9%A2%84%E7%BA%A6%E7%9B%B8%E5%85%B3%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">1.8.1.3.</span> <span class="toc-text">7.1.3 预约相关触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-3-1-%E9%A2%84%E7%BA%A6%E7%8A%B6%E6%80%81%E5%8F%98%E6%9B%B4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">1.8.1.3.1.</span> <span class="toc-text">7.1.3.1 预约状态变更触发器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-3-2-%E9%A2%84%E7%BA%A6%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">1.8.1.3.2.</span> <span class="toc-text">7.1.3.2 预约删除触发器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-4-%E7%BB%B4%E4%BF%AE%E7%9B%B8%E5%85%B3%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">1.8.1.4.</span> <span class="toc-text">7.1.4 维修相关触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-4-1-%E7%BB%B4%E4%BF%AE%E8%AE%B0%E5%BD%95%E5%88%9B%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">1.8.1.4.1.</span> <span class="toc-text">7.1.4.1 维修记录创建触发器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-4-2-%E7%BB%B4%E4%BF%AE%E7%8A%B6%E6%80%81%E5%8F%98%E6%9B%B4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">1.8.1.4.2.</span> <span class="toc-text">7.1.4.2 维修状态变更触发器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-4-3-%E7%BB%B4%E4%BF%AE%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91"><span class="toc-number">1.8.1.4.3.</span> <span class="toc-text">7.1.4.3 维修删除触发</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-5-%E9%87%87%E8%B4%AD%E7%9B%B8%E5%85%B3%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">1.8.1.5.</span> <span class="toc-text">7.1.5 采购相关触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-5-1-%E9%87%87%E8%B4%AD%E7%8A%B6%E6%80%81%E5%8F%98%E6%9B%B4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">1.8.1.5.1.</span> <span class="toc-text">7.1.5.1 采购状态变更触发器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-5-2-%E9%87%87%E8%B4%AD%E5%88%9B%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">1.8.1.5.2.</span> <span class="toc-text">7.1.5.2 采购创建触发器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-6-%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">1.8.1.6.</span> <span class="toc-text">7.1.6 使用记录触发器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.8.2.</span> <span class="toc-text">7.2 存储过程系统设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-%E9%A2%84%E7%BA%A6%E7%AE%A1%E7%90%86%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">7.2.1 预约管理存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-1-1-%E9%A2%84%E7%BA%A6%E5%AE%A1%E6%89%B9%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.1.1.</span> <span class="toc-text">7.2.1.1 预约审批存储过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-1-2-%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8%E8%AE%BE%E5%A4%87%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.1.2.</span> <span class="toc-text">7.2.1.2 开始使用设备存储过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-1-3-%E5%AE%8C%E6%88%90%E4%BD%BF%E7%94%A8%E8%AE%BE%E5%A4%87%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.1.3.</span> <span class="toc-text">7.2.1.3 完成使用设备存储过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-1-4-%E5%8F%96%E6%B6%88%E9%A2%84%E7%BA%A6%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.1.4.</span> <span class="toc-text">7.2.1.4 取消预约存储过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-1-5-%E6%9F%A5%E8%AF%A2%E8%AE%BE%E5%A4%87%E5%8F%AF%E7%94%A8%E6%97%B6%E9%97%B4%E6%AE%B5%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.1.5.</span> <span class="toc-text">7.2.1.5 查询设备可用时间段存储过程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-2-%E7%BB%B4%E4%BF%AE%E7%AE%A1%E7%90%86%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">7.2.2 维修管理存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-2-1-%E5%88%86%E6%B4%BE%E7%BB%B4%E4%BF%AE%E4%BB%BB%E5%8A%A1%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.2.1.</span> <span class="toc-text">7.2.2.1 分派维修任务存储过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-2-2-%E5%BC%80%E5%A7%8B%E7%BB%B4%E4%BF%AE%E4%BB%BB%E5%8A%A1%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.2.2.</span> <span class="toc-text">7.2.2.2 开始维修任务存储过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-2-3-%E5%AE%8C%E6%88%90%E7%BB%B4%E4%BF%AE%E4%BB%BB%E5%8A%A1%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.2.3.</span> <span class="toc-text">7.2.2.3 完成维修任务存储过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-2-4-%E8%8E%B7%E5%8F%96%E7%BB%B4%E4%BF%AE%E4%BA%BA%E5%91%98%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%8D%B7%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.2.4.</span> <span class="toc-text">7.2.2.4 获取维修人员工作负荷存储过程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-3-%E9%87%87%E8%B4%AD%E7%AE%A1%E7%90%86%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">7.2.3 采购管理存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-3-1-%E5%88%9B%E5%BB%BA%E9%87%87%E8%B4%AD%E5%B7%A5%E5%8D%95%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.3.1.</span> <span class="toc-text">7.2.3.1 创建采购工单存储过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-3-2-%E5%AE%A1%E6%89%B9%E9%87%87%E8%B4%AD%E5%B7%A5%E5%8D%95%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.3.2.</span> <span class="toc-text">7.2.3.2 审批采购工单存储过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-3-3-%E8%8E%B7%E5%8F%96%E9%87%87%E8%B4%AD%E7%BB%9F%E8%AE%A1%E6%8A%A5%E8%A1%A8%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.3.3.</span> <span class="toc-text">7.2.3.3 获取采购统计报表存储过程</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E7%B3%BB%E7%BB%9F%E5%90%84%E9%A1%B9%E5%8A%9F%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AB%AF%E6%93%8D%E4%BD%9C%E4%B8%BB%E8%A6%81%E4%BB%A3%E7%A0%81%E4%B8%8E%E7%BB%93%E6%9E%9C%E8%AF%B4%E6%98%8E"><span class="toc-number">1.9.</span> <span class="toc-text">八、系统各项功能数据库端操作主要代码与结果说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E9%A2%84%E7%BA%A6%E7%AE%A1%E7%90%86"><span class="toc-number">1.9.1.</span> <span class="toc-text">8.1 预约管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-1-%E7%94%A8%E6%88%B7%E9%A2%84%E7%BA%A6%E8%AE%BE%E5%A4%87%E6%B5%81%E7%A8%8B"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">8.1.1 用户预约设备流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-2-%E6%9F%A5%E8%AF%A2%E8%AE%BE%E5%A4%87%E5%8F%AF%E7%94%A8%E6%97%B6%E9%97%B4%E6%AE%B5"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">8.1.2 查询设备可用时间段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E7%BB%B4%E4%BF%AE%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">1.9.2.</span> <span class="toc-text">8.2 维修管理功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-1-%E8%AE%BE%E5%A4%87%E6%8A%A5%E4%BF%AE%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">8.2.1 设备报修完整流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-2-%E7%BB%B4%E4%BF%AE%E4%BA%BA%E5%91%98%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%8D%B7%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">8.2.2 维修人员工作负荷查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E9%87%87%E8%B4%AD%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">1.9.3.</span> <span class="toc-text">8.3 采购管理功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-1-%E9%87%87%E8%B4%AD%E5%B7%A5%E5%8D%95%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">8.3.1 采购工单完整流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-2-%E9%87%87%E8%B4%AD%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">8.3.2 采购统计分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">1.9.4.</span> <span class="toc-text">8.4 用户管理功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-1-%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%B8%8E%E7%99%BB%E5%BD%95"><span class="toc-number">1.9.4.1.</span> <span class="toc-text">8.4.1 用户注册与登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-2-%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E6%9B%B4%E6%96%B0"><span class="toc-number">1.9.4.2.</span> <span class="toc-text">8.4.2 用户信息更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">1.9.5.</span> <span class="toc-text">8.5 设备管理功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-5-1-%E8%AE%BE%E5%A4%87%E7%8A%B6%E6%80%81%E8%87%AA%E5%8A%A8%E5%90%8C%E6%AD%A5"><span class="toc-number">1.9.5.1.</span> <span class="toc-text">8.5.1 设备状态自动同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-5-2-%E8%AE%BE%E5%A4%87%E5%88%97%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.9.5.2.</span> <span class="toc-text">8.5.2 设备列表查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E6%80%A7%E9%AA%8C%E8%AF%81"><span class="toc-number">1.9.6.</span> <span class="toc-text">8.6 数据完整性验证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-6-1-%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.6.1.</span> <span class="toc-text">8.6.1 外键约束测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-6-2-%E5%94%AF%E4%B8%80%E7%BA%A6%E6%9D%9F%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.6.2.</span> <span class="toc-text">8.6.2 唯一约束测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-7-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E9%AA%8C%E8%AF%81"><span class="toc-number">1.9.7.</span> <span class="toc-text">8.7 性能优化验证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-7-1-%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8%E9%AA%8C%E8%AF%81"><span class="toc-number">1.9.7.1.</span> <span class="toc-text">8.7.1 索引使用验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-7-2-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E9%AA%8C%E8%AF%81"><span class="toc-number">1.9.7.2.</span> <span class="toc-text">8.7.2 并发控制验证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">1.10.</span> <span class="toc-text">九、总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/12/29/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/" title="实验室设备管理系统"><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="实验室设备管理系统"/></a><div class="content"><a class="title" href="/2025/12/29/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/" title="实验室设备管理系统">实验室设备管理系统</a><time datetime="2025-12-29T03:05:42.000Z" title="发表于 2025-12-29 11:05:42">2025-12-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/28/%E6%9C%80%E4%BC%98%E5%8C%96%E5%A4%8D%E4%B9%A0%E6%8F%90%E7%BA%B2/" title="最优化复习提纲"><img src="/images/%E6%9C%80%E4%BC%98%E5%8C%96/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="最优化复习提纲"/></a><div class="content"><a class="title" href="/2025/12/28/%E6%9C%80%E4%BC%98%E5%8C%96%E5%A4%8D%E4%B9%A0%E6%8F%90%E7%BA%B2/" title="最优化复习提纲">最优化复习提纲</a><time datetime="2025-12-28T03:06:08.000Z" title="发表于 2025-12-28 11:06:08">2025-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/26/GCN%E5%AD%A6%E4%B9%A0%E6%8A%A5%E5%91%8A/" title="GCN学习报告"><img src="/images/GCN/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GCN学习报告"/></a><div class="content"><a class="title" href="/2025/09/26/GCN%E5%AD%A6%E4%B9%A0%E6%8A%A5%E5%91%8A/" title="GCN学习报告">GCN学习报告</a><time datetime="2025-09-26T15:38:36.000Z" title="发表于 2025-09-26 23:38:36">2025-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/19/C%E8%AF%AD%E8%A8%80%E7%B3%BB%E7%BB%9F%E7%BA%A7%E7%BC%96%E7%A8%8B-%E4%BA%8C/" title="C语言系统级编程(二)"><img src="/images/C_SYS_2/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C语言系统级编程(二)"/></a><div class="content"><a class="title" href="/2025/09/19/C%E8%AF%AD%E8%A8%80%E7%B3%BB%E7%BB%9F%E7%BA%A7%E7%BC%96%E7%A8%8B-%E4%BA%8C/" title="C语言系统级编程(二)">C语言系统级编程(二)</a><time datetime="2025-09-19T13:29:56.000Z" title="发表于 2025-09-19 21:29:56">2025-09-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/15/C%E8%AF%AD%E8%A8%80%E7%B3%BB%E7%BB%9F%E7%BA%A7%E7%BC%96%E7%A8%8B-%E4%B8%80/" title="C语言系统级编程(一)"><img src="/images/C_SYS_1/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C语言系统级编程(一)"/></a><div class="content"><a class="title" href="/2025/09/15/C%E8%AF%AD%E8%A8%80%E7%B3%BB%E7%BB%9F%E7%BA%A7%E7%BC%96%E7%A8%8B-%E4%B8%80/" title="C语言系统级编程(一)">C语言系统级编程(一)</a><time datetime="2025-09-14T16:04:25.000Z" title="发表于 2025-09-15 00:04:25">2025-09-15</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/header.png);"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Boom_freezing</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css')
    if (true) {
      await btf.getScript('https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script></div><div class="aplayer no-destroy" data-id="9125417643" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="/dist/live2d-widget-master/dist/waifu.css"><!-- (Placeholder removed) Initialization will run without temporary placeholder UI--><!-- Load runtime + widget module directly from distribution to avoid autoload parsing issues--><!-- Load Live2D runtime (non-module) first--><script src="/dist/live2d-widget-master/dist/live2d.min.js"></script><!-- Temporary safety wrapper: wrap event listeners to catch runtime errors--><!-- This prevents uncaught exceptions from Live2D pointer handlers before model is ready--><script>(function(){
  try{
    var _origAdd = EventTarget.prototype.addEventListener;
    EventTarget.prototype.addEventListener = function(type, listener, options){
      try{
        var wrapped = function(e){ try { return listener.call(this,e); } catch(err) { console.error('[waifu] listener error', err); } };
        return _origAdd.call(this, type, wrapped, options);
      }catch(e){ return _origAdd.call(this, type, listener, options); }
    };
    // mark so we can inspect in console if needed
    window.__waifu_wrap_listeners = true;
  }catch(e){}
})();
</script><!-- Load the bundled widget as an ES module (waifu-tips.js)--><script type="module" src="/dist/live2d-widget-master/dist/waifu-tips.js"></script><!-- Initialization is performed early in head.pug; here we keep a small PJAX re-init hook--><script>(function(){
  function reinit(){
    if(typeof initWidget === 'function'){
      try{ initWidget(); console.info('[waifu] reinit called'); }catch(e){ console.warn('[waifu] reinit failed', e); }
    }
  }
  try{ document.addEventListener('pjax:complete', reinit); document.addEventListener('pjax:end', reinit); }catch(e){}
})();
</script><!-- Fallback: if no config_path provided, autoload.js may auto initialize using its own config--></div></body></html>